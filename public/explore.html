<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="View and accept requests on Coded Signals">
    <title>Coded Signals - Requests</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Inter:wght@300;400;500&display=swap" rel="stylesheet">
 <style>
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.1);
        }
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(to bottom, #FF4DA6, #FF77C6);
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(to bottom, #FF77C6, #FF4DA6);
        }

        /* Card hover effect */
        .request-card {
            transition: all 0.3s ease;
            background: rgba(31, 41, 55, 0.7);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 1rem;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        .request-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(255, 77, 166, 0.2);
        }

        /* Pulse animation */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .online-dot {
            width: 8px;
            height: 8px;
            background-color: #10b981;
            border-radius: 50%;
            display: inline-block;
            margin-left: 6px;
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        /* Floating action button animation */
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        .fab {
            animation: float 3s ease-in-out infinite;
            position: fixed;
            bottom: 5rem;
            right: 2rem;
            background: linear-gradient(to right, #FF4DA6, #FF77C6);
            border-radius: 50%;
            padding: 1rem;
            box-shadow: 0 4px 15px rgba(255, 77, 166, 0.3);
            transition: transform 0.2s ease;
            z-index: 50;
        }
        .fab:hover {
            transform: scale(1.1);
        }

        /* Gradient text */
        .gradient-text {
            background: linear-gradient(to right, #FF4DA6, #FF77C6);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .btn-gradient {
            background: linear-gradient(to right, #FF4DA6, #FF77C6);
            transition: all 0.3s ease;
        }
        .btn-gradient:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(255, 77, 166, 0.3);
        }

        .search-input:focus {
            border-color: #FF4DA6;
            box-shadow: 0 0 0 3px rgba(255, 77, 166, 0.1);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(31, 41, 55, 0.8);
            backdrop-filter: blur(8px);
            z-index: 50;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background: rgba(31, 41, 55, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 1rem;
            padding: 1.5rem;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            scroll-behavior: smooth;
            position: relative;
            color: #f3f4f6;
            transform: scale(0.95);
            opacity: 0;
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
        }
        .modal-open .modal-content {
            transform: scale(1);
            opacity: 1;
        }
        .modal-content textarea,
        .modal-content input[type="file"],
        .modal-content select {
            width: 100%;
            border: 1px solid #4b5563;
            border-radius: 0.5rem;
            padding: 0.5rem;
            background: #374151;
            color: #f3f4f6;
            overflow-wrap: break-word;
            word-break: break-word;
        }
        .modal-content textarea:focus,
        .modal-content input[type="file"]:focus,
        .modal-content select:focus {
            border-color: #FF4DA6;
            outline: none;
        }
        .modal-close {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: none;
            border: none;
            font-size: 1.25rem;
            color: #9ca3af;
            cursor: pointer;
        }
        .toast {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            background: #10b981;
            color: white;
            padding: 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            z-index: 40;
            display: none;
            transition: opacity 0.3s ease;
        }
        .toast.error {
            background: #ef4444;
        }
        .no-posts {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            text-align: center;
            color: #9ca3af;
            font-size: 1.25rem;
            font-weight: 500;
        }
        .no-posts i {
            margin-bottom: 1.5rem;
            width: 3rem;
            height: 3rem;
        }
        .loader {
            width: 50px;
            aspect-ratio: 1;
            display: grid;
            border: 4px solid #0000;
            border-radius: 50%;
            border-right-color: #FF4DA6;
            animation: l15 1s infinite linear;
            margin: 2rem auto;
        }
        .loader::before,
        .loader::after {
            content: "";
            grid-area: 1/1;
            margin: 2px;
            border: inherit;
            border-radius: 50%;
            animation: l15 2s infinite;
        }
        .loader::after {
            margin: 8px;
            animation-duration: 3s;
        }
        @keyframes l15 {
            100% { transform: rotate(1turn) }
        }
        .truncate-text {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            overflow-wrap: break-word;
            word-break: break-word;
        }
        .read-more {
            color: #FF4DA6;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
        }
        .read-more:hover {
            text-decoration: underline;
        }
        .payment-modal textarea {
            resize: vertical;
            min-height: 100px;
        }
        @media (min-width: 1024px) {
            .container {
                max-width: 1280px;
                margin: 0 auto;
                padding-left: 1.5rem;
                padding-right: 1.5rem;
            }
            h1 {
                font-size: 1.75rem;
            }
            .search-input {
                max-width: 600px;
                font-size: 1rem;
            }
            .nav-item {
                font-size: 1rem;
                padding: 0.5rem 1rem;
            }
            .loader {
                margin: 3rem auto;
            }
            .request-card {
                max-width: 600px;
                margin-left: auto;
                margin-right: auto;
            }
            .no-posts {
                font-size: 1.5rem;
                padding: 4rem;
            }
        }
        @media (max-width: 1023px) {
            .top-nav {
                display: none;
            }
            .fab {
                display: none;
            }
            .container {
                padding-left: 0.5rem;
                padding-right: 0.5rem;
            }
            .request-card {
                padding: 0.75rem;
            }
        }
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            border: 0;
        }
        .loading .content {
            display: none;
        }

        /* Center container for larger screens (aligned with home.html) */
        .container {
            max-width: 1280px;
            margin-left: auto;
            margin-right: auto;
            padding-left: 1rem;
            padding-right: 1rem;
        }
        @media (min-width: 1024px) {
            .container {
                padding-left: 2rem;
                padding-right: 2rem;
            }
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 font-sans min-h-screen flex flex-col">
    <!-- Top Navigation for Desktop -->
    <nav class="top-nav sticky top-0 z-20 bg-gray-900/80 border-b border-gray-800 py-4 px-6 backdrop-blur-sm">
        <div class="container flex items-center justify-between">
            <h1 class="text-xl font-bold gradient-text">Coded <span class="text-white">Signals</span></h1>
            <div class="hidden lg:flex items-center space-x-6">
                <a href="home.html" class="nav-item font-medium text-gray-400 hover:text-pink-400">
                    <i data-feather="home" class="w-5 h-5 inline mr-1"></i> Home
                </a>
                <a href="explore.html" class="nav-item active font-medium text-pink-400" aria-current="page">
                    <i data-feather="plus-circle" class="w-5 h-5 inline mr-1"></i> Request
                </a>
                <a href="chat.html" class="nav-item font-medium text-gray-400 hover:text-pink-400">
                    <i data-feather="message-square" class="w-5 h-5 inline mr-1"></i> Chat
                </a>
                <a href="profile.html" class="nav-item font-medium text-gray-400 hover:text-pink-400">
                    <i data-feather="user" class="w-5 h-5 inline mr-1"></i> Profile
                </a>
            </div>
        </div>
    </nav>

    <!-- Header for Mobile -->
    <header class="sticky top-0 z-10 bg-gray-900/80 border-b border-gray-800 py-4 px-6 lg:hidden backdrop-blur-sm">
        <div class="container flex items-center justify-between">
            <h1 class="text-xl font-bold gradient-text">Coded <span class="text-white">Signals</span></h1>
            <div class="flex items-center space-x-4">
                <button class="p-2 rounded-full hover:bg-gray-700" aria-label="Notifications">
                    <i data-feather="bell" class="w-5 h-5 text-pink-400"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- Floating Action Button -->
    <button class="fab hidden lg:block" aria-label="Create a new request" data-modal-toggle="post-modal">
        <i data-feather="plus" class="w-6 h-6 text-white"></i>
    </button>

    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>

    <!-- Post Creation Modal -->
    <div id="post-modal" class="modal" role="dialog" aria-labelledby="post-modal-title" aria-hidden="true">
        <div class="modal-content">
            <button class="modal-close p-2 rounded-full hover:bg-gray-700" aria-label="Close post modal">
                <i data-feather="x" class="w-5 h-5 text-gray-400"></i>
            </button>
            <h2 id="post-modal-title" class="text-lg font-semibold gradient-text mb-4">Create a Request</h2>
            <form id="post-form">
                <label for="post-content" class="text-sm font-medium mb-1 block">Request Description</label>
                <textarea id="post-content" placeholder="What's your request?" class="mb-4" required aria-required="true"></textarea>
                <label for="post-image" class="text-sm font-medium mb-1 block">Upload Image (Optional)</label>
                <input id="post-image" type="file" accept="image/*" class="mb-4">
                <label for="duration-select" class="text-sm font-medium mb-1 block">Select Duration (Days)</label>
                <select id="duration-select" class="mb-4" required>
                    <option value="1" data-post-type="quick">1 Day (Free)</option>
                    <option value="7" data-post-type="extended-7">7 Days ($5)</option>
                    <option value="30" data-post-type="extended-30">30 Days ($20)</option>
                </select>
                <div class="flex justify-end space-x-2">
                    <button type="button" class="px-4 py-2 text-gray-400 rounded-full hover:bg-gray-700" onclick="closePostModal()">Cancel</button>
                    <button type="submit" class="btn-gradient text-white px-6 py-2 rounded-full">Submit Request</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Payment Modal -->
    <div id="payment-modal" class="modal" role="dialog" aria-labelledby="payment-title" aria-hidden="true">
        <div class="modal-content">
            <button class="modal-close p-2 rounded-full hover:bg-gray-700" aria-label="Close payment modal">
                <i data-feather="x" class="w-5 h-5 text-gray-400"></i>
            </button>
            <h2 id="payment-title" class="text-lg font-semibold gradient-text mb-4">Payment Confirmation</h2>
            <p id="payment-message" class="text-sm text-gray-300 mb-4">Please make the payment and upload proof to create your post.</p>
            <div id="account-details" class="bg-gray-800 p-4 rounded mb-4">
                <h3 class="font-medium mb-2">Payment Details</h3>
                <p><strong>Bank:</strong> <span id="bank-name"></span></p>
                <p><strong>Account Number:</strong> <span id="account-number"></span></p>
                <p><strong>Account Name:</strong> <span id="account-name"></span></p>
                <p><strong>Reference:</strong> <span id="reference"></span></p>
                <p class="text-xs text-gray-500 mt-2">Transfer the amount and upload proof below.</p>
            </div>
            <div id="countdown-timer" class="text-sm text-gray-300 mb-4">Please wait: <span id="timer-seconds">60</span> seconds</div>
            <form id="payment-form">
                <label for="proof-upload" class="text-sm font-medium mb-1 block">Upload Proof of Payment</label>
                <input type="file" id="proof-upload" accept="image/*,application/pdf" class="mb-4" required>
                <div class="flex justify-end space-x-2">
                    <button type="button" class="px-4 py-2 text-gray-400 rounded-full hover:bg-gray-700" onclick="closePaymentModal()">Cancel</button>
                    <button type="submit" id="submit-proof-btn" class="btn-gradient text-white px-6 py-2 rounded-full" disabled>Submit Proof</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Request Detail Modal (Mobile Only) -->
    <div id="post-detail-modal" class="modal" role="dialog" aria-labelledby="post-detail-title" aria-hidden="true">
        <div class="modal-content">
            <button class="modal-close p-2 rounded-full hover:bg-gray-700" aria-label="Close post detail modal">
                <i data-feather="x" class="w-5 h-5 text-gray-400"></i>
            </button>
            <h2 id="post-detail-title" class="sr-only">Request Details</h2>
            <div class="flex items-center mb-4">
                <img id="post-detail-user-image" src="" alt="User profile picture" class="w-10 h-10 rounded-full object-cover mr-3">
                <div>
                    <h3 id="post-detail-username" class="font-medium"></h3>
                    <p id="post-detail-info" class="text-xs text-gray-400"></p>
                    <p id="post-detail-time" class="text-xs text-gray-400"></p>
                </div>
            </div>
            <p id="post-detail-caption" class="text-sm text-gray-300 mb-4"></p>
            <div class="flex justify-between">
                <a id="post-detail-profile" href="#" class="text-sm text-gray-400 hover:text-pink-400">View Profile</a>
                <button id="post-detail-accept" class="btn-gradient text-white text-sm px-4 py-2 rounded-full">Accept Request</button>
            </div>
        </div>
    </div>

    <!-- Read More Modal -->
    <div id="read-more-modal" class="modal" role="dialog" aria-labelledby="read-more-title" aria-hidden="true">
        <div class="modal-content">
            <button class="modal-close p-2 rounded-full hover:bg-gray-700" aria-label="Close read more modal">
                <i data-feather="x" class="w-5 h-5 text-gray-400"></i>
            </button>
            <h2 id="read-more-title" class="text-lg font-semibold gradient-text mb-4">Request Details</h2>
            <p id="read-more-content" class="text-sm text-gray-300 mb-4"></p>
            <div class="flex justify-end">
                <button id="read-more-accept" class="btn-gradient text-white text-sm px-4 py-2 rounded-full">Accept Request</button>
            </div>
        </div>
    </div>

    <main class="flex-1 py-8 container px-4 overflow-y-auto">
        <!-- Loader -->
        <div class="loader" aria-label="Loading requests page"></div>

        <!-- Content -->
        <div class="content">
           
            

            <!-- Requests Section -->
            <section aria-labelledby="request-posts">
                <div class="request-list"></div>
                <div class="no-posts hidden">
                    <i data-feather="alert-circle" class="w-8 h-8 mb-4"></i>
                    <p>No requests available at the moment.</p>
                </div>
            </section>
        </div>
    </main>

    <!-- Bottom Navigation for Mobile -->
    <nav class="bottom-nav fixed bottom-0 left-0 right-0 bg-gray-900/80 border-t border-gray-800 flex justify-around py-3 px-4 lg:hidden backdrop-blur-sm z-30">
        <a href="home.html" class="nav-item flex flex-col items-center text-xs text-gray-400 hover:text-pink-400">
            <i data-feather="home" class="w-5 h-5 mb-1"></i>
            <span>Home</span>
        </a>
        <a href="explore.html" class="nav-item active flex flex-col items-center text-xs text-pink-400" aria-current="page">
            <i data-feather="plus-circle" class="w-5 h-5 mb-1"></i>
            <span>Request</span>
        </a>
        <a href="#" class="nav-item flex flex-col items-center text-xs text-gray-400 hover:text-pink-400 post-link" data-modal-toggle="post-modal">
            <div class="bg-gradient-to-r from-pink-500 to-pink-300 text-white rounded-full p-3 shadow-lg">
                <i data-feather="plus" class="w-6 h-6"></i>
            </div>
            <span class="mt-2">Post</span>
        </a>
        <a href="chat.html" class="nav-item flex flex-col items-center text-xs text-gray-400 hover:text-pink-400">
            <i data-feather="message-square" class="w-5 h-5 mb-1"></i>
            <span>Chat</span>
        </a>
        <a href="profile.html" class="nav-item flex flex-col items-center text-xs text-gray-400 hover:text-pink-400">
            <i data-feather="user" class="w-5 h-5 mb-1"></i>
            <span>Profile</span>
        </a>
    </nav>

    <script>
        feather.replace();

        const socket = io();
        const token = localStorage.getItem('token');
        let currentUserId = null;

        if (token) {
            const payload = JSON.parse(atob(token.split('.')[1]));
            currentUserId = payload._id || payload.userId;
            socket.emit('user-connected', currentUserId);
        } else {
            console.error('No token found, redirecting to login');
            showToast('Please log in to view requests', true);
            window.location.href = 'login.html';
        }

        socket.on('user-status-update', async ({ userId, isOnline }) => {
            console.log(`User ${userId} status changed to ${isOnline ? 'online' : 'offline'}`);
            const posts = await fetchPosts();
            await renderPosts(posts);
        });

        socket.on('post-accepted', async ({ postId }) => {
            console.log(`Post ${postId} accepted, refreshing posts`);
            const posts = await fetchPosts();
            await renderPosts(posts);
        });

        socket.on('new-chat', async (chat) => {
            console.log('New chat received:', chat);
            showToast(`New chat started for post!`);
            const posts = await fetchPosts();
            await renderPosts(posts);
        });

        const defaultPostImage = 'data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/2wCEAAkGBwgHBgkIBwgKCgkLDRYPDQwMDRsUFRAWIB0iIiAdHx8kKDQsJCYxJx8fLT0tMTU3Ojo6Iys/RD84QzQ5OjcBCgoKDQwNGg8PGjclHyU3Nzc3Nzc3Nzc3Nzc3Nzc3Nzc3Nzc3Nzc3Nzc3Nzc3Nzc3Nzc3Nzc3Nzc3Nzc3N//AABEIAMAAzAMBIgACEQEDEQH/xAAbAAEBAAMBAQEAAAAAAAAAAAAAAQIEBQYDB//EADEQAAIBAgQFAgUCBwAAAAAAAAABAgMRBAUhMRJBUWFxIjITI1KBsWKRFDNCcoLB8P/EABUBAQEAAAAAAAAAAAAAAAAAAAAB/8QAFhEBAQEAAAAAAAAAAAAAAAAAAAER/9oADAMBAAIRAxEAPwD9cABUAAAAAAAAAAAAAAAAAAAAAAAAQgIADBGAZL9gyMD7AAAAAAAAAAAUh869enh0nOW+y5sD6A49fNKkvTRjwR67s06larU91ST8sD0fHBf1R/cqaezT+55i19ypuL9Lt40A9OQ4FLG16T0qN9nqjo4bMqVRqNVfDm9L8gN4D9tdrcxcAQMjAEBADDIwAZAyXQH3AAAAAAAAKQ+eIrKhTc5dLLyB8sdjFhYJR1qS2XTucSpUnUm51JcTe4qVJVZuc3eTerMAAALgAAYBfsQDBu4LHyoPgqNyp8v0nYumlJO6e1uZ5p7W0OhlWJal/D1H6XrFvk+hB1WQXAEDDI2BGAQAzFlbI7AbIAAAAAAAByM4rcdeNFPSCu/J2NtTzVaXHWnN7uTYgwABQAAAAAAABGxdppp2sRgD0OGq/Gw9Op9S188z6HPyad6M6b5Suu1zfIKzEEbAtzFstzFgHqY3YuLgbYAAAAAAAMartSqNfSzzR6aa4oSj1TR5pq2j5CCAAoAAAAABGGQAQADoZM/mVV+j/Z1DmZMtasu3CdMgGJSMCNkDZGBGQEuBvAAAAAAAAu2p57HUvhYqpDZOV0egNDNsP8Smq0fdDfwByH2IAWAAABGHsQAQpGAIGfTD0nXrRh1evgDq5XT4MIpc5tt+NjbY4VFKMdloiMgMxKzEAQGLAMgbMbgdEAAAAAAAANXuuVrMADh4/CPDzvFN0pPTt2ZqOx6acYzg4yWj3Rx8Xl86XzKPrhyS3iINEg/7wHsUGQlygQnMpnRo1K8lGnG/4AwjGUpJRV3fQ7OBwyw8Ly1m9307FwmDjh/U3xVOvTwbDIHkjD2IAMWymN9QI2CMlwDZjd8mGyNgdMAAAAAAAAF/J8MRiqWHV6ktei3A+xL2e9n+xx8RmdWo7UUoQ68zRnUnKXE5yb7u4Hfr4WhX98LT6rRmlUypX+XUa7NGrRzDEUlbj+Iukzahm8bfMpSX9rA+TyyvfScLeQsqqN+qqkbKzSg1qpr7GEs2or2wm/sBlTyyhDWd5+djajwwjaKUI9kcupmlR/yqcYvq9TSq16tZ3q1JS8vQD0RjJ6nBpYuvR9lRtdJao38PmUJWjVio+NgN5kZE+JXTVuqDYEbIGS4BsxYZjcAYl2In2A6oAAAAAA9rmjmeLdGPwqb9ct+yAxx+YfCbpUdZrRvkjkyk5ScpO7fNk6pXIUUxFwAIABHboARgCMMjAMmtwAPvh8XUw7tF3h9LOvRrQrQ44P0/g8+fXDYidCpxRfpe66kHdZi2SNRTipRd09gwDZixcjYEbJcNjiS3A64AAAFW6A/deqqNKVSW0VfyecqTlUnKcm25Pc6ec1tIUf8AJr8HLEAjYZCgQAAQEAEAAjIUgBmNysxAE2VgyAdDKq9pOhJ76xOizz8JuE4yjvHY7sZqcYyjs1cgrMStkAGOpWS4HZAAAAPYDgY+fxMXUfR2NZmVR8VWb7swYAgYKBGAAICACAjANmLZSSAjHIjAEIUjAjOtl0+PDRX0to5B0cpfoqeSDfI2VmPMAL2Ix97fcDtABsA9jF7Aj2A81P3y8shZ+6XkxAEKQoEBABGCAAGzG4AgIwDIGQAzEMXAh0cp9tTyjnXN/KfbU8og6JiwwAIGEB//2Q==';

        let tempPostData = null;

        function formatRelativeTime(date) {
            const now = new Date();
            const diffMs = now - new Date(date);
            const diffSeconds = Math.floor(diffMs / 1000);
            const diffMinutes = Math.floor(diffSeconds / 60);
            const diffHours = Math.floor(diffMinutes / 60);
            const diffDays = Math.floor(diffHours / 24);
            const diffWeeks = Math.floor(diffDays / 7);

            if (diffSeconds < 60) return `${diffSeconds} seconds ago`;
            if (diffMinutes < 60) return `${diffMinutes} minute${diffMinutes === 1 ? '' : 's'} ago`;
            if (diffHours < 24) return `${diffHours} hour${diffHours === 1 ? '' : 's'} ago`;
            if (diffDays < 7) return `${diffDays} day${diffDays === 1 ? '' : 's'} ago`;
            if (diffWeeks < 4) return `${diffWeeks} week${diffWeeks === 1 ? '' : 's'} ago`;
            return new Date(date).toLocaleDateString();
        }

        function calculateDistance(userLocation) {
            return userLocation ? `${Math.floor(Math.random() * 10 + 1)} km away` : 'N/A';
        }

        async function getCurrentUserLocation() {
            if (!token) {
                console.error('No token found for current user');
                return null;
            }
            try {
                console.log('Fetching current user location');
                const response = await fetch('/api/users/current', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                if (!response.ok) {
                    throw new Error(data.error || 'Failed to fetch current user');
                }
                return data.location || null;
            } catch (error) {
                console.error('Get current user location error:', error.message);
                showToast(error.message, true);
                return null;
            }
        }

        async function fetchPosts() {
            if (!token) {
                console.error('No token found in localStorage');
                showToast('Please log in to view requests', true);
                return [];
            }
            try {
                console.log('Fetching posts from /api/posts');
                const response = await fetch('/api/posts', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const posts = await response.json();
                if (!response.ok) {
                    throw new Error(posts.error || 'Failed to fetch requests');
                }
                return posts;
            } catch (error) {
                console.error('Fetch posts error:', error.message);
                showToast(error.message, true);
                return [];
            }
        }

        async function renderPosts(posts) {
            const requestList = document.querySelector('.request-list');
            const noPosts = document.querySelector('.no-posts');
            if (!requestList || !noPosts) {
                console.error('Request list or no-posts element not found');
                showToast('Failed to initialize request list', true);
                return;
            }
            requestList.innerHTML = '';
            noPosts.classList.add('hidden');

            if (posts.length === 0) {
                noPosts.classList.remove('hidden');
                noPosts.querySelector('p').textContent = 'No requests available at the moment.';
                feather.replace();
                return;
            }

            const currentUserLocation = await getCurrentUserLocation();

            posts.forEach(post => {
                if (!post.content || !post.user?.fullName || !post.user?.avatar || !post.createdAt || !post.user?._id) {
                    console.warn('Skipping post due to incomplete data:', post);
                    return;
                }
                const distance = calculateDistance(post.user.location);
                const isOnline = post.user.isOnline || false;
                const statusDot = isOnline ? '<span class="online-dot" title="Online"></span>' : '';
                const isLongText = post.content.length > 100;
                const displayContent = isLongText ? post.content.substring(0, 100) + '...' : post.content;
                const hasAccepted = post.acceptances?.some(acc => acc.user.toString() === currentUserId);
                const requestCard = document.createElement('div');
                requestCard.className = 'request-card';
                requestCard.dataset.caption = post.content;
                requestCard.dataset.username = post.user.fullName;
                requestCard.dataset.userImage = post.user.avatar;
                requestCard.dataset.time = formatRelativeTime(post.createdAt);
                requestCard.dataset.userId = post.user._id;
                requestCard.dataset.postId = post._id;
                requestCard.dataset.age = post.user.age || 'N/A';
                requestCard.dataset.distance = distance;
                requestCard.dataset.isOnline = isOnline;

                requestCard.innerHTML = `
                    <div class="flex items-start">
                        <img src="${post.user.avatar || defaultPostImage}" alt="${post.user.fullName} profile picture" class="w-12 h-12 rounded-full object-cover mr-3" onerror="this.src='${defaultPostImage}'">
                        <div class="flex-1">
                            <div class="flex justify-between items-center">
                                <div>
                                    <h3 class="font-medium text-white text-sm inline-flex items-center">${post.user.fullName}, ${post.user.age || 'N/A'} ${statusDot}</h3>
                                    <p class="text-xs text-gray-400">${distance} • ${formatRelativeTime(post.createdAt)}</p>
                                </div>
                                <a href="profile-view.html?id=${post.user._id}" class="text-xs text-gray-400 hover:text-pink-400">View Profile</a>
                            </div>
                            <p class="text-sm text-gray-300 mt-2 truncate-text">${displayContent}</p>
                            ${isLongText ? '<span class="read-more" role="button" tabindex="0">Read More</span>' : ''}
                            <div class="flex justify-end mt-3">
                                <button class="accept-request btn-gradient text-white text-sm px-4 py-2 rounded-full" data-post-id="${post._id}" data-username="${post.user.fullName}" ${hasAccepted ? 'disabled' : ''}>${hasAccepted ? 'Accepted' : 'Accept Request'}</button>
                            </div>
                        </div>
                    </div>
                `;
                requestList.appendChild(requestCard);
            });

            document.querySelectorAll('.accept-request').forEach(button => {
                button.addEventListener('click', () => {
                    button.disabled = true;
                    const postId = button.dataset.postId;
                    const username = button.dataset.username;
                    acceptRequest(postId, username).finally(() => {
                        button.disabled = false;
                    });
                });
            });

            document.querySelectorAll('.read-more').forEach(link => {
                link.addEventListener('click', () => {
                    const card = link.closest('.request-card');
                    const content = card.dataset.caption;
                    const postId = card.dataset.postId;
                    const username = card.dataset.username;
                    openReadMoreModal(content, postId, username);
                });
                link.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        const card = link.closest('.request-card');
                        const content = card.dataset.caption;
                        const postId = card.dataset.postId;
                        const username = card.dataset.username;
                        openReadMoreModal(content, postId, username);
                    }
                });
            });

            feather.replace();
        }

        async function acceptRequest(postId, username) {
            if (!token) {
                showToast('Please log in to accept', true);
                return;
            }
            try {
                console.log('Sending accept request:', { postId, username });
                const response = await fetch('/api/posts/accept', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ postId })
                });
                const data = await response.json();
                if (!response.ok) {
                    if (data.requiresPayment) {
                        openPaymentModal(data.message || 'You have reached the limit of 5 acceptances. Pay to unlock more.', 'unlock_acceptances', postId);
                        return;
                    }
                    throw new Error(data.error || 'Failed to accept request');
                }
                if (!data.chatId) {
                    throw new Error('Chat creation failed: No chat ID returned');
                }
                showToast(`Connection request sent to ${username}! Redirecting to chat...`);
                setTimeout(() => {
                    window.location.href = `chat.html?chatId=${data.chatId}`;
                }, 1000);
                socket.emit('post-accepted', { postId });
            } catch (error) {
                console.error('Accept request error:', error.message);
                showToast(error.message, true);
            }
        }

        function openReadMoreModal(content, postId, username) {
            const readMoreModal = document.getElementById('read-more-modal');
            const readMoreContent = document.getElementById('read-more-content');
            const readMoreAccept = document.getElementById('read-more-accept');
            readMoreContent.textContent = content;
            readMoreAccept.dataset.postId = postId;
            readMoreAccept.dataset.username = username;
            readMoreModal.style.display = 'flex';
            readMoreModal.classList.add('modal-open');
            readMoreModal.setAttribute('aria-hidden', 'false');
            readMoreContent.focus();
        }

        let countdownInterval = null;

        function startCountdown() {
            const timerSeconds = document.getElementById('timer-seconds');
            const submitBtn = document.getElementById('submit-proof-btn');
            let seconds = 60;
            timerSeconds.textContent = seconds;
            submitBtn.disabled = true;
            countdownInterval = setInterval(() => {
                seconds--;
                timerSeconds.textContent = seconds;
                if (seconds <= 0) {
                    clearInterval(countdownInterval);
                    submitBtn.disabled = false;
                    timerSeconds.parentElement.style.display = 'none';
                }
            }, 1000);
        }

        function openPaymentModal(message, type, postId = '') {
            const modal = document.getElementById('payment-modal');
            const messageEl = document.getElementById('payment-message');
            const bank = document.getElementById('bank-name');
            const accountNumber = document.getElementById('account-number');
            const accountName = document.getElementById('account-name');
            const reference = document.getElementById('reference');
            const form = document.getElementById('payment-form');
            const timer = document.getElementById('countdown-timer');

            messageEl.textContent = message;
            form.dataset.type = type;
            form.dataset.postId = postId;

            try {
                console.log('Fetching account details for payment');
                fetch('/api/users/account-details', {
                    headers: { 'Authorization': `Bearer ${token}` }
                })
                    .then(response => response.json())
                    .then(data => {
                        if (!data.accountDetails) {
                            throw new Error(data.error || 'Failed to fetch account details');
                        }
                        bank.textContent = data.accountDetails.bank;
                        accountNumber.textContent = data.accountDetails.accountNumber;
                        accountName.textContent = data.accountDetails.accountName;
                        reference.textContent = data.accountDetails.reference;
                        modal.style.display = 'flex';
                        modal.classList.add('modal-open');
                        modal.setAttribute('aria-hidden', 'false');
                        timer.style.display = 'block';
                        startCountdown();
                        document.getElementById('proof-upload').focus();
                    })
                    .catch(error => {
                        console.error('Account details error:', error.message);
                        showToast(error.message, true);
                    });
            } catch (error) {
                console.error('Payment modal error:', error.message);
                showToast(error.message, true);
            }
        }

        function closePaymentModal() {
            const modal = document.getElementById('payment-modal');
            modal.classList.remove('modal-open');
            clearInterval(countdownInterval);
            setTimeout(() => {
                modal.style.display = 'none';
                modal.setAttribute('aria-hidden', 'true');
                document.getElementById('payment-form').reset();
                document.getElementById('countdown-timer').style.display = 'block';
                document.getElementById('submit-proof-btn').disabled = true;
                tempPostData = null;
            }, 300);
        }

        async function handlePaymentSubmit(e) {
            e.preventDefault();
            const form = e.target;
            const type = form.dataset.type;
            const postId = form.dataset.postId;
            const proofFile = document.getElementById('proof-upload').files[0];

            if (!proofFile) {
                showToast('Please upload proof', true);
                return;
            }

            try {
                console.log('Submitting payment proof:', { type, postId });
                const formData = new FormData();
                formData.append('proof', proofFile);
                formData.append('purpose', type);
                formData.append('postId', postId || 'temp-' + Date.now());
                formData.append('amount', type === 'post_creation' && tempPostData ? (tempPostData.duration === '7' ? 5 : 20) : 5);

                const response = await fetch('/api/users/upload', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` },
                    body: formData
                });
                const data = await response.json();
                if (!response.ok) {
                    throw new Error(data.error || 'Payment submission failed');
                }

                if (type === 'post_creation' && tempPostData) {
                    const postData = {
                        content: tempPostData.content,
                        sponsored: tempPostData.duration !== '1',
                        postType: tempPostData.postType,
                        duration: tempPostData.duration,
                        paymentId: data.paymentId
                    };

                    console.log('Creating sponsored post:', postData);
                    const postResponse = await fetch('/api/posts', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(postData)
                    });
                    const postResult = await postResponse.json();
                    if (!postResponse.ok) {
                        throw new Error(postResult.error || 'Failed to create post');
                    }
                    showToast('Post submitted, awaiting payment verification.');
                    closePaymentModal();
                    closePostModal();
                    const posts = await fetchPosts();
                    await renderPosts(posts);
                } else if (type === 'unlock_acceptances') {
                    console.log('Attempting to accept post after payment:', { postId, paymentId: data.paymentId });
                    const acceptResponse = await fetch('/api/posts/accept', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ postId, paymentId: data.paymentId })
                    });
                    const acceptData = await acceptResponse.json();
                    if (!acceptResponse.ok) {
                        throw new Error(acceptData.error || 'Failed to accept request');
                    }
                    if (!acceptData.chatId) {
                        throw new Error('Chat creation failed: No chat ID returned');
                    }
                    showToast('Connection request sent to ' + form.dataset.username + '! Redirecting to chat...');
                    closePaymentModal();
                    setTimeout(() => {
                        window.location.href = `chat.html?chatId=${acceptData.chatId}`;
                    }, 1000);
                    const posts = await fetchPosts();
                    await renderPosts(posts);
                }
            } catch (error) {
                console.error('Payment error:', error.message);
                showToast(error.message, true);
            }
        }

        function closePostModal() {
            const modal = document.getElementById('post-modal');
            modal.classList.remove('modal-open');
            setTimeout(() => {
                modal.style.display = 'none';
                modal.setAttribute('aria-hidden', 'true');
                document.getElementById('post-form').reset();
                tempPostData = null;
            }, 300);
        }

        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const body = document.body;
                const loader = document.querySelector('.loader');
                const content = document.querySelector('.content');

                if (!loader || !content) {
                    throw new Error('Loader or content element not found');
                }

                console.log('Initializing explore page');
                body.classList.add('loading');
                const posts = await fetchPosts();
                body.classList.remove('loading');
                loader.style.display = 'none';
                content.style.display = 'block';
                await renderPosts(posts);

                feather.replace();
            } catch (error) {
                console.error('Page initialization error:', error.message);
                showToast('Failed to initialize page', true);
            }
        });

        const postModal = document.getElementById('post-modal');
        const postLinks = document.querySelectorAll('.post-link, .fab');
        const postCloseBtn = postModal.querySelector('.modal-close');
        const postForm = document.getElementById('post-form');
        const toast = document.getElementById('toast');
        const postDetailModal = document.getElementById('post-detail-modal');
        const postDetailCloseBtn = postDetailModal.querySelector('.modal-close');
        const readMoreModal = document.getElementById('read-more-modal');
        const readMoreCloseBtn = readMoreModal.querySelector('.modal-close');
        const readMoreAccept = document.getElementById('read-more-accept');

        function showToast(message, isError = false) {
            toast.textContent = message;
            toast.className = `toast ${isError ? 'error' : ''}`;
            toast.style.display = 'block';
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => {
                    toast.style.display = 'none';
                    toast.style.opacity = '1';
                }, 300);
            }, 3000);
        }

        postLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                postModal.style.display = 'flex';
                postModal.classList.add('modal-open');
                postModal.setAttribute('aria-hidden', 'false');
                document.getElementById('post-content').focus();
            });
        });

        postCloseBtn.addEventListener('click', closePostModal);

        postModal.addEventListener('click', (e) => {
            if (e.target === postModal) {
                closePostModal();
            }
        });

        postForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const postContent = document.getElementById('post-content').value;
            const postImage = document.getElementById('post-image').files[0];
            const durationSelect = document.getElementById('duration-select');
            const duration = durationSelect.value;
            const postType = durationSelect.selectedOptions[0].dataset.postType;

            if (!token) {
                console.error('No token found for post creation');
                showToast('Please log in to create a request', true);
                return;
            }

            const postData = { content: postContent, image: postImage, duration, postType };

            if (duration === '1') {
                try {
                    console.log('Creating free post:', postData);
                    const response = await fetch('/api/posts', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            content: postData.content,
                            sponsored: false,
                            postType: postData.postType,
                            duration: postData.duration
                        })
                    });
                    const result = await response.json();
                    if (!response.ok) {
                        throw new Error(result.error || 'Failed to create post');
                    }
                    showToast('Free post created successfully!');
                    closePostModal();
                    const posts = await fetchPosts();
                    await renderPosts(posts);
                } catch (error) {
                    console.error('Free post error:', error.message);
                    showToast(error.message, true);
                }
            } else {
                console.log('Opening payment modal for sponsored post:', postData);
                tempPostData = postData;
                openPaymentModal('Please make the payment and upload proof to create your post.', 'post_creation');
            }
        });

        document.querySelector('.request-list').addEventListener('click', (e) => {
            const item = e.target.closest('.request-card');
            if (item && window.innerWidth < 1024 && !e.target.classList.contains('accept-request') && !e.target.closest('a') && !e.target.classList.contains('read-more')) {
                const caption = item.dataset.caption;
                const username = item.dataset.username;
                const userImage = item.dataset.userImage;
                const time = item.dataset.time;
                const userId = item.dataset.userId;
                const age = item.dataset.age;
                const distance = item.dataset.distance;
                const isOnline = item.dataset.isOnline === 'true';
                const postId = item.dataset.postId;

                console.log('Opening post detail modal:', { caption, username, userId });
                document.getElementById('post-detail-caption').textContent = caption;
                document.getElementById('post-detail-username').textContent = `${username}, ${age}`;
                document.getElementById('post-detail-user-image').src = userImage;
                document.getElementById('post-detail-info').textContent = distance;
                document.getElementById('post-detail-time').innerHTML = `${isOnline ? '<span class="online-dot" title="Online"></span>' : ''} ${time}`;
                document.getElementById('post-detail-profile').href = `profile-view.html?id=${userId}`;
                document.getElementById('post-detail-accept').dataset.username = username;
                document.getElementById('post-detail-accept').dataset.postId = postId;
                document.getElementById('post-detail-accept').disabled = item.querySelector('.accept-request').disabled;

                postDetailModal.style.display = 'flex';
                postDetailModal.classList.add('modal-open');
                postDetailModal.setAttribute('aria-hidden', 'false');
            }
        });

        postDetailCloseBtn.addEventListener('click', () => {
            console.log('Closing post detail modal');
            postDetailModal.classList.remove('modal-open');
            setTimeout(() => {
                postDetailModal.style.display = 'none';
                postDetailModal.setAttribute('aria-hidden', 'true');
            }, 300);
        });

        postDetailModal.addEventListener('click', (e) => {
            if (e.target === postDetailModal) {
                console.log('Closing post detail modal via backdrop');
                postDetailModal.classList.remove('modal-open');
                setTimeout(() => {
                    postDetailModal.style.display = 'none';
                    postDetailModal.setAttribute('aria-hidden', 'true');
                }, 300);
            }
        });

        document.getElementById('post-detail-accept').addEventListener('click', () => {
            const username = document.getElementById('post-detail-accept').dataset.username;
            const postId = document.getElementById('post-detail-accept').dataset.postId;
            console.log('Accepting from post detail modal:', { postId, username });
            document.getElementById('post-detail-accept').disabled = true;
            acceptRequest(postId, username).finally(() => {
                document.getElementById('post-detail-accept').disabled = false;
            });
        });

        readMoreCloseBtn.addEventListener('click', () => {
            console.log('Closing read more modal');
            readMoreModal.classList.remove('modal-open');
            setTimeout(() => {
                readMoreModal.style.display = 'none';
                readMoreModal.setAttribute('aria-hidden', 'true');
            }, 300);
        });

        readMoreModal.addEventListener('click', (e) => {
            if (e.target === readMoreModal) {
                console.log('Closing read more modal via backdrop');
                readMoreModal.classList.remove('modal-open');
                setTimeout(() => {
                    readMoreModal.style.display = 'none';
                    readMoreModal.setAttribute('aria-hidden', 'true');
                }, 300);
            }
        });

        readMoreAccept.addEventListener('click', () => {
            const username = readMoreAccept.dataset.username;
            const postId = readMoreAccept.dataset.postId;
            console.log('Accepting from read more modal:', { postId, username });
            readMoreAccept.disabled = true;
            acceptRequest(postId, username).finally(() => {
                readMoreAccept.disabled = false;
            });
        });

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                if (postModal.style.display === 'flex') {
                    console.log('Closing post modal via Escape key');
                    closePostModal();
                }
                if (postDetailModal.style.display === 'flex') {
                    console.log('Closing post detail modal via Escape key');
                    postDetailModal.classList.remove('modal-open');
                    setTimeout(() => {
                        postDetailModal.style.display = 'none';
                        postDetailModal.setAttribute('aria-hidden', 'true');
                    }, 300);
                }
                if (readMoreModal.style.display === 'flex') {
                    console.log('Closing read more modal via Escape key');
                    readMoreModal.classList.remove('modal-open');
                    setTimeout(() => {
                        readMoreModal.style.display = 'none';
                        readMoreModal.setAttribute('aria-hidden', 'true');
                    }, 300);
                }
                if (document.getElementById('payment-modal').style.display === 'flex') {
                    console.log('Closing payment modal via Escape key');
                    closePaymentModal();
                }
            }
        });

        document.getElementById('payment-form').addEventListener('submit', handlePaymentSubmit);
    </script>
</body>
</html>