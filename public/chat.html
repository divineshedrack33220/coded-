<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="Chat with friends and connections on Coded Signals">
    <title>Coded Signals - Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    <script src="/socket.io/socket.io.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #FF4DA6;
            --secondary: #FF77C6;
            --bg-primary: #0f172a;
            --bg-chat: #111827;
            --card-bg: #1e293b;
            --border: #334155;
            --text: #e2e8f0;
            --text-muted: #94a3b8;
        }
        html, body { margin:0; padding:0; height:100%; background:var(--bg-primary); font-family:'Inter',sans-serif; color:var(--text); overscroll-behavior:none; }
        .top-nav { position:fixed; top:0; left:0; right:0; z-index:50; background:rgba(15,23,42,0.95); backdrop-filter:blur(12px); border-bottom:1px solid var(--border); padding:12px 16px; display:flex; align-items:center; }
        .back-button { display:none; margin-right:12px; padding:8px; border-radius:50%; transition:all 0.2s; }
        .back-button:hover { background:rgba(255,255,255,0.1); }
        .back-button.visible { display:block; }
        @media (min-width:768px) { .back-button { display:none !important; } }
        .chat-container { display:flex; height:calc(100vh - 64px); margin-top:64px; }
        .chat-sidebar { width:100%; max-width:420px; background:var(--bg-chat); border-right:1px solid var(--border); overflow-y:auto; display:flex; flex-direction:column; }
        .search-bar { padding:16px; border-bottom:1px solid var(--border); background:var(--bg-chat); }
        .search-input { background:#1e293b; border:1px solid #334155; border-radius:16px; padding:12px 48px 12px 44px; color:white; width:100%; font-size:15px; }
        .search-input:focus { outline:none; border-color:var(--primary); box-shadow:0 0 0 3px rgba(255,77,166,0.3); }
        .chat-card { padding:16px 20px; border-bottom:1px solid var(--border); transition:all 0.2s ease; cursor:pointer; display:flex; align-items:center; gap:16px; }
        .chat-card:hover { background:rgba(255,77,166,0.08); }
        .chat-card.active { background:rgba(255,77,166,0.12); border-left:4px solid var(--primary); padding-left:16px; }
        .unread-badge { background:linear-gradient(135deg,var(--primary),var(--secondary)); min-width:22px; height:22px; border-radius:11px; font-size:11px; font-weight:700; color:white; display:flex; align-items:center; justify-content:center; }
        .online-dot { position:absolute; bottom:0; right:0; width:14px; height:14px; background:#10b981; border:3px solid var(--bg-chat); border-radius:50%; }
        .fab { position:fixed; bottom:24px; right:20px; width:56px; height:56px; background:linear-gradient(135deg,var(--primary),var(--secondary)); border-radius:50%; box-shadow:0 4px 20px rgba(255,77,166,0.4); z-index:40; display:flex; align-items:center; justify-content:center; transition:all 0.2s; }
        .fab:hover { transform:scale(1.1); box-shadow:0 8px 30px rgba(255,77,166,0.5); }
        .gradient-text { background:linear-gradient(to right,var(--primary),var(--secondary)); -webkit-background-clip:text; background-clip:text; color:transparent; }
        .placeholder { display:flex; flex-direction:column; align-items:center; justify-content:center; color:var(--text-muted); }
        .placeholder i { width:80px; height:80px; opacity:0.3; margin-bottom:24px; }
        @media (min-width:768px) { .fab { bottom:32px; right:32px; } }
    </style>
</head>
<body class="flex flex-col h-screen">

    <!-- Top Nav with Back Button (mobile only) -->
    <header class="top-nav">
        <button id="back-btn" class="back-button" onclick="history.back()" aria-label="Go back">
            <i data-feather="arrow-left" class="w-6 h-6"></i>
        </button>
        <div class="flex items-center justify-between flex-1">
            <h1 class="text-2xl font-bold gradient-text">Coded Signals</h1>
        </div>
    </header>

    <div class="chat-container">
        <!-- Sidebar -->
        <aside class="chat-sidebar">
            <div class="search-bar">
                <div class="relative">
                    <i data-feather="search" class="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-500"></i>
                    <input type="text" id="search-input" placeholder="Search chats..." class="search-input">
                </div>
            </div>
            <div id="chat-list-container" class="flex-1 overflow-y-auto"></div>
            <div id="no-chats" class="hidden placeholder py-20">
                <i data-feather="message-square"></i>
                <p class="text-xl font-medium">No conversations yet</p>
                <p class="text-sm mt-2">Start connecting with people!</p>
            </div>
        </aside>

        <!-- Desktop Placeholder -->
        <main class="flex-1 bg-var(--bg-primary) hidden md:flex placeholder">
            <i data-feather="message-square"></i>
            <p class="text-2xl">Select a chat to start messaging</p>
        </main>
    </div>

    <!-- FAB -->
    <button class="fab" id="new-chat-btn">
        <i data-feather="plus" class="w-8 h-8 text-white"></i>
    </button>

    <!-- Toast -->
    <div id="toast" class="fixed bottom-24 left-1/2 -translate-x-1/2 px-6 py-3 rounded-full bg-green-600 text-white z-50 hidden shadow-xl"></div>

    <script>
        const API_URL = 'https://codedsignal.org';
        const defaultProfileImage = 'data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/2wCEAAkGBxAHBhAPBw4PDxUPEA8VEBgQDw8QDg8PFRMWFhcRFRMYHSgiGBolHRUVITEhJSktLi4uFx8zODcsNygtLisBCgoKDQ0NFQ0NFSsZFRkrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrK//AABEIAOEA4QMBIgACEQEDEQH/xAAaAAEAAwEBAQAAAAAAAAAAAAAAAQQFAgMH/8QAMRABAAEDAQMKBgIDAAAAAAAAAAECAxEEIUGBBRIiMTJhcZGhsRMzQlFy0SM0U8Hx/8QAFQEBAQAAAAAAAAAAAAAAAAAAAAH/xAAUEQEAAAAAAAAAAAAAAAAAAAAA/9oADAMBAAIRAxEAPwD6oAqAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAPK7qKbXanb9o6weozrmtqq7ERHrLym/XPXVPngGsMj4tUfVV5y7p1NdP1Tx2g1BRo10/XTHCcLtMxVGadvh1AkAAAAAAAAAAAAAAAAAAABFUxTGatmEqGvudKKY3bZ8QRqdXNc4t7I9ZVQUAAAAHdq7NmrNE/qXADWs3YvUZjjH2ejM0VfNvxH32NNAAAAAAAAAAAAAAAAAAAY92v4lyZnfPo1L84s1fjLJAAUAAAAAATRVza4mN0w2WK2YnMIJAAAAAAAAAAAAAAAAAB5an+vV+Mspr3ozaqjun2ZAACgAAAAAA1rE5s0/jHsyWvZjFmn8afZB2AAAAAAAAAAAAAAAAACtrbk27ccycZlnNDlCP4Y/KPaWeAAoAAAAAANHQ3JuUTz5zidnkzmhyfH8Mz3/wCoQWgAAAAAAAAAAAAAAAAAeOqp52nq8M+TLbMxmMTvZuq0/wADHNnOcg8AFAAAAAABqaSnm6envjPmpabT/HzmcYxxaVMc2mIjcgkAAAAAAAAAAAAAAAAABW11HOsZjdMTw6llFUc6MTvBjD0v2ptXMTw74eagAAAADuzb+LciI490Av6KjmWI79qwiIxGxKAAAAAAAAAAAAAAAAAAAACnyjHQpnvn2UV3lGejTHfMqSgAAAAt8ndurwj3VFrk6cXZj7x7SDQAQAAAAAAAAAAAAAAAAARMxTGapx4glTv63E4tRxn9F7WxGy1t756lGZzOZ3g6rrm5Oa5y5BQAAAATTVNFWaZwgBcs63Gy7Ge+P0uxOY2MZcs63Gy7HGP0gvDmiuK4zRMT4OgAAAAAAAAAABxduRapzXOPeVK5rpn5cY9ZBoPK5fpt9qqOG2WbXdqr7VUzx2eTgFy5rv8AHHn+lWu5NyenMy5AAAAFAAAAAAABBNNc0TmmZjwWreumPmRnj2SqANS3qaK+qceOx7MV1TcmjszMcQbAzretqp7fS9JXbN6m9HRnhvgHoAAAA4u3It0TNW71dqPKNW2mOIKt25N2vNf/AByCgAAAAAAAAAAAAAAAAAAAAmiqaKs0ziYQA1dPd+Nbzv3+L1Z2gqxex949YaKAAAz+UPmx4R7yAKoCgAAAAAAAAAAAAAAAAAAAAAD30X9iOPtLTBAAB//Z';

        const socket = io(API_URL);
        const token = localStorage.getItem('token');
        let currentUserId = null;

        const dom = {
            toast: document.getElementById('toast'),
            backBtn: document.getElementById('back-btn'),
            searchInput: document.getElementById('search-input'),
            chatListContainer: document.getElementById('chat-list-container'),
            noChats: document.getElementById('no-chats')
        };

        // Show back button only on mobile when coming from a chat
        if (window.innerWidth < 768 && document.referrer.includes('messages.html')) {
            dom.backBtn.classList.add('visible');
        }

        if (!token) {
            showToast('Please log in to view conversations', true);
            window.location.href = '/login.html';
        } else {
            try {
                const payload = JSON.parse(atob(token.split('.')[1]));
                currentUserId = payload._id || payload.userId;
                socket.emit('user-connected', currentUserId);
            } catch (e) {
                showToast('Invalid token. Please log in again.', true);
                window.location.href = '/login.html';
            }
        }

        function showToast(message, isError = false) {
            dom.toast.textContent = message;
            dom.toast.className = `fixed bottom-24 left-1/2 -translate-x-1/2 px-6 py-3 rounded-full shadow-xl z-50 text-white ${isError ? 'bg-red-600' : 'bg-green-600'}`;
            dom.toast.style.display = 'block';
            setTimeout(() => dom.toast.style.display = 'none', 3500);
        }

        function formatRelativeTime(date) {
            const diff = Date.now() - new Date(date);
            const sec = Math.floor(diff / 1000);
            if (sec < 60) return `${sec}s`;
            const min = Math.floor(sec / 60);
            if (min < 60) return `${min}m`;
            const hr = Math.floor(min / 60);
            if (hr < 24) return `${hr}h`;
            const day = Math.floor(hr / 24);
            if (day < 7) return `${day}d`;
            return new Date(date).toLocaleDateString();
        }

        async function fetchChats() {
            const res = await fetch(`${API_URL}/api/chats`, { headers: { Authorization: `Bearer ${token}` } });
            if (!res.ok) throw new Error((await res.json()).error || 'Failed');
            return await res.json();
        }

        async function renderChats(chats) {
            dom.chatListContainer.innerHTML = '';
            dom.noChats.classList.toggle('hidden', chats.length > 0);

            const unique = new Map();
            chats.forEach(c => {
                if (!unique.has(c.recipient._id) || new Date(unique.get(c.recipient._id).updatedAt) < new Date(c.updatedAt)) {
                    unique.set(c.recipient._id, c);
                }
            });

            Array.from(unique.values())
                .sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt))
                .forEach(chat => {
                    const div = document.createElement('div');
                    div.className = `chat-card ${chat.unreadCount > 0 ? 'font-medium' : ''}`;
                    div.dataset.id = chat._id;
                    div.innerHTML = `
                        <div class="relative flex-shrink-0">
                            <img src="${chat.recipient.profilePicture || defaultProfileImage}" class="w-14 h-14 rounded-full object-cover" onerror="this.src='${defaultProfileImage}'">
                            ${chat.recipient.isOnline ? '<div class="online-dot"></div>' : ''}
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex justify-between items-baseline">
                                <h3 class="font-semibold truncate text-base">${chat.recipient.name}</h3>
                                <span class="text-xs text-gray-500">${formatRelativeTime(chat.updatedAt)}</span>
                            </div>
                            <div class="flex justify-between items-center mt-1">
                                <p class="text-sm text-gray-400 truncate">${chat.lastMessage || 'No messages yet'}</p>
                                ${chat.unreadCount > 0 ? `<div class="unread-badge">${chat.unreadCount > 9 ? '9+' : chat.unreadCount}</div>` : ''}
                            </div>
                        </div>
                    `;
                    div.onclick = () => {
                        dom.backBtn.classList.add('visible');
                        window.location.href = `/messages.html?chatId=${chat._id}`;
                    };
                    dom.chatListContainer.appendChild(div);
                });
        }

        document.addEventListener('DOMContentLoaded', async () => {
            feather.replace();

            try {
                const chats = await fetchChats();
                await renderChats(chats);
            } catch (e) {
                showToast(e.message, true);
            }

            // Search
            dom.searchInput.addEventListener('input', () => {
                const term = dom.searchInput.value.toLowerCase();
                document.querySelectorAll('.chat-card').forEach(card => {
                    const name = card.querySelector('h3').textContent.toLowerCase();
                    const msg = card.querySelector('p').textContent.toLowerCase();
                    card.style.display = (name.includes(term) || msg.includes(term)) ? '' : 'none';
                });
            });

            // Real-time updates
            socket.on('new-message', async () => {
                const chats = await fetchChats();
                await renderChats(chats);
            });
        });
    </script>
</body>

</html>
