<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="Chat with friends and connections on Coded Signals">
    <title>Coded Signals - Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    <script src="/socket.io/socket.io.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #FF4DA6;
            --secondary: #FF77C6;
            --bg-dark: #1F2937;
            --bg-darker: #111827;
            --border-light: rgba(255, 255, 255, 0.1);
            --text-light: #F3F4F6;
            --text-muted: #9CA3AF;
            --input-bg: #374151;
            --input-border: #4b5563;
        }
        html, body {
            margin: 0;
            font-family: 'Inter', sans-serif;
            overscroll-behavior: none;
            touch-action: manipulation;
            overflow-x: hidden;
            overflow-y: auto;
            background: var(--bg-dark);
            color: var(--text-light);
        }
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        .gradient-text {
            background: linear-gradient(to right, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }
        .chat-list-item {
            transition: all 0.2s ease;
            border-left: 3px solid transparent;
        }
        .chat-list-item:hover, .chat-list-item.active {
            background-color: rgba(255, 77, 166, 0.05);
            border-left-color: var(--primary);
        }
        .unread-badge {
            background: var(--primary);
            border-radius: 10px;
            min-width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 600;
            color: white;
        }
        .loader {
            width: 50px;
            aspect-ratio: 1;
            display: grid;
            border: 4px solid transparent;
            border-radius: 50%;
            border-right-color: var(--primary);
            animation: l15 1s infinite linear;
            margin: 2rem auto;
        }
        .loader::before,
        .loader::after {
            content: "";
            grid-area: 1/1;
            margin: 2px;
            border: inherit;
            border-radius: 50%;
            animation: l15 2s infinite;
        }
        .loader::after {
            margin: 8px;
            animation-duration: 3s;
        }
        @keyframes l15 {
            100% { transform: rotate(1turn) }
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(31, 41, 55, 0.8);
            backdrop-filter: blur(5px);
            z-index: 50;
            align-items: center;
            justify-content: center;
        }
        .modal.active {
            display: flex;
        }
        .modal-content {
            background: var(--bg-darker);
            backdrop-filter: blur(5px);
            border: 1px solid var(--border-light);
            border-radius: 1rem;
            padding: 1.5rem;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            color: var(--text-light);
            transform: scale(0.95);
            opacity: 0;
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
        }
        .modal.active .modal-content {
            transform: scale(1);
            opacity: 1;
        }
        .modal-content input {
            width: 100%;
            border: 1px solid var(--input-border);
            border-radius: 0.5rem;
            padding: 0.75rem;
            background: var(--input-bg);
            color: var(--text-light);
        }
        .modal-content input:focus {
            border-color: var(--primary);
            outline: none;
        }
        .modal-close {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: none;
            border: none;
            font-size: 1.25rem;
            color: var(--text-muted);
            cursor: pointer;
        }
        .modal-close:hover {
            color: var(--secondary);
        }
        .no-chats {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            text-align: center;
            color: var(--text-muted);
            font-size: 1.25rem;
        }
        .no-chats i {
            margin-bottom: 1rem;
            width: 2rem;
            height: 2rem;
        }
        .top-nav {
            position: sticky;
            top: 0;
            background: var(--bg-darker);
            border-bottom: 1px solid var(--border-light);
            z-index: 30;
            padding: 0.75rem 1rem;
        }
        .back-button {
            padding: 0.5rem;
            border-radius: 50%;
            background: var(--primary);
            transition: background-color 0.3s ease;
        }
        .back-button i {
            color: #ffffff;
        }
        .back-button:hover {
            background: var(--secondary);
        }
        .back-button:hover i {
            color: #ffffff;
        }
        .back-button:focus {
            outline: 2px solid #ffffff;
            outline-offset: 2px;
        }
        .new-chat-button {
            padding: 0.5rem;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
        }
        .new-chat-button i {
            color: white;
            width: 20px;
            height: 20px;
        }
        .new-chat-button:hover i {
            color: white;
        }
        .container {
            max-width: 1280px;
            margin: 0 auto;
            box-sizing: border-box;
        }
        .chat-container {
            display: flex;
            flex-direction: column;
            min-height: calc(100vh - 60px);
        }
        .chat-list {
            width: 100%;
            background: var(--bg-darker);
            border-right: 1px solid var(--border-light);
            overflow-y: auto;
            transform: translateX(0);
            transition: transform 0.3s ease;
        }
        .chat-list.hidden {
            transform: translateX(-100%);
        }
        .chat-iframe {
            display: none;
            flex: 1;
            width: 100%;
            height: calc(100vh - 60px);
            min-width: 0;
            border: none;
            background: var(--bg-dark);
        }
        .chat-iframe-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: calc(100vh - 60px);
            color: var(--text-muted);
            font-size: 1.25rem;
            text-align: center;
            background: var(--bg-dark);
        }
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-darker);
            border-top: 1px solid var(--border-light);
            display: flex;
            justify-content: space-around;
            padding: 0.75rem 1rem;
            z-index: 30;
        }
        @media (min-width: 768px) {
            .chat-container {
                flex-direction: row;
                min-height: calc(100vh - 60px);
            }
            .chat-list {
                width: 320px;
                transform: none;
                max-height: calc(100vh - 60px);
                overflow-y: auto;
            }
            .chat-iframe {
                display: block;
            }
            .chat-iframe-placeholder {
                display: flex;
            }
            h1 {
                font-size: 1.75rem;
            }
            .bottom-nav {
                display: none;
            }
        }
        @media (max-width: 767px) {
            .chat-list {
                max-height: calc(100vh - 120px);
                overflow-y: auto;
                padding-top: 60px;
                padding-bottom: 60px;
            }
            .top-nav {
                position: fixed;
                top: 0;
                width: 100%;
                padding: 0.75rem 0.5rem;
                padding-right: calc(0.5rem + env(safe-area-inset-right, 0));
                padding-left: calc(0.5rem + env(safe-area-inset-left, 0));
                z-index: 30;
            }
            .chat-iframe-placeholder {
                display: none;
            }
        }
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            border: 0;
        }
        .loading .content {
            display: none;
        }
        .toast {
            transition: opacity 0.3s ease;
        }
        .search-input {
            background-color: rgba(255, 255, 255, 0.05);
            border: 1px solid transparent;
            border-radius: 8px;
            padding: 8px 12px 8px 36px;
            color: white;
            transition: all 0.2s ease;
        }
        .search-input:focus {
            outline: none;
            border-color: var(--primary);
            background-color: rgba(255, 255, 255, 0.1);
        }
        .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">
    <!-- Top Navigation -->
    <nav class="top-nav">
        <div class="container flex items-center justify-center md:justify-between">
            <!-- Mobile: Only show "Coded Signals" centered -->
            <h1 class="text-xl font-bold gradient-text md:hidden">Coded Signals</h1>
            <!-- Desktop: "Coded Signals" on left, nav links on right -->
            <div class="hidden md:flex items-center justify-between w-full">
                <h1 class="text-xl font-bold gradient-text">Coded Signals</h1>
                <div class="flex items-center space-x-6">
                    <a href="home.html" class="nav-item font-medium text-gray-400 hover:text-pink-400">
                        <i data-feather="home" class="w-5 h-5 inline mr-1"></i> Home
                    </a>
                    <a href="explore.html" class="nav-item font-medium text-gray-400 hover:text-pink-400">
                        <i data-feather="plus-circle" class="w-5 h-5 inline mr-1"></i> Request
                    </a>
                    <a href="chat.html" class="nav-item active font-medium text-pink-400" aria-current="page">
                        <i data-feather="message-square" class="w-5 h-5 inline mr-1"></i> Chat
                    </a>
                    <a href="profile.html" class="nav-item font-medium text-gray-400 hover:text-pink-400">
                        <i data-feather="user" class="w-5 h-5 inline mr-1"></i> Profile
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Bottom Navigation for Mobile Only -->
    <nav class="bottom-nav lg:hidden">
        <a href="home.html" class="nav-item flex flex-col items-center text-xs text-gray-400 hover:text-pink-400">
            <i data-feather="home" class="w-5 h-5 mb-1"></i>
            <span>Home</span>
        </a>
        <a href="explore.html" class="nav-item flex flex-col items-center text-xs text-gray-400 hover:text-pink-400">
            <i data-feather="plus-circle" class="w-5 h-5 mb-1"></i>
            <span>Request</span>
        </a>
        <a href="chat.html" class="nav-item active flex flex-col items-center text-xs text-pink-400" aria-current="page">
            <i data-feather="message-square" class="w-5 h-5 mb-1"></i>
            <span>Chat</span>
        </a>
        <a href="profile.html" class="nav-item flex flex-col items-center text-xs text-gray-400 hover:text-pink-400">
            <i data-feather="user" class="w-5 h-5 mb-1"></i>
            <span>Profile</span>
        </a>
    </nav>

    <!-- Toast Notification -->
    <div id="toast" class="toast fixed bottom-4 right-4 px-4 py-2 rounded-lg shadow-lg z-40 bg-green-500 text-white hidden" role="alert" aria-live="assertive"></div>
    <!-- New Chat Modal -->
    <div id="new-chat-modal" class="modal" role="dialog" aria-labelledby="new-chat-modal-title" aria-hidden="true">
        <div class="modal-content">
            <button class="modal-close" aria-label="Close modal">
                <i data-feather="x" class="w-5 h-5"></i>
            </button>
            <h2 id="new-chat-modal-title" class="text-lg font-semibold gradient-text mb-4">Start a New Chat</h2>
            <form id="new-chat-form">
                <label for="chat-recipient" class="text-sm font-medium mb-1 block">Recipient</label>
                <input id="chat-recipient" type="text" placeholder="Enter recipient's name..." class="mb-4" required aria-required="true">
                <div class="flex justify-end space-x-2">
                    <button type="button" class="px-4 py-2 text-gray-400 rounded-full hover:bg-gray-700" onclick="closeNewChatModal()">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-gradient-to-r from-[var(--primary)] to-[var(--secondary)] text-white rounded-full">Start Chat</button>
                </div>
            </form>
        </div>
    </div>
    <main class="flex-1 container">
        <!-- Loader -->
        <div class="loader" aria-label="Loading chats"></div>
        <!-- Content -->
        <div class="content">
            <div class="chat-container">
                <!-- Chat List -->
                <section id="chat-list" class="chat-list" aria-label="Conversations">
                    <div class="p-3">
                        <div class="relative">
                            <input type="text" placeholder="Search messages" class="search-input w-full text-sm placeholder-gray-500">
                            <i data-feather="search" class="search-icon w-4 h-4"></i>
                        </div>
                    </div>
                    <div id="chat-list-container" class="space-y-1 px-2 pb-3"></div>
                    <div class="no-chats hidden">
                        <i data-feather="message-square" class="w-8 h-8 mb-2"></i>
                        <p>No conversations available at the moment.</p>
                    </div>
                </section>
                <!-- Chat Iframe (PC only) -->
                <iframe id="chat-iframe" class="chat-iframe" title="Chat conversation" src=""></iframe>
                <div id="chat-iframe-placeholder" class="chat-iframe-placeholder flex flex-col items-center justify-center space-y-4">
                    <i data-feather="message-square" class="w-8 h-8 text-gray-500"></i>
                    <p class="text-lg text-gray-500">Select a chat to start messaging</p>
                </div>
            </div>
        </div>
    </main>
    <script>
        const defaultProfileImage = 'data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/2wCEAAkGBxAHBhAPBw4PDxUPEA8VEBgQDw8QDg8PFRMWFhcRFRMYHSgiGBolHRUVITEhJSktLi4uFx8zODcsNygtLisBCgoKDQ0NFQ0NFSsZFRkrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrK//AABEIAOEA4QMBIgACEQEDEQH/xAAaAAEAAwEBAQAAAAAAAAAAAAAAAQQFAgMH/8QAMRABAAEDAQMKBgIDAAAAAAAAAAECAxEEIUGBBRIiMTJhcZGhsRMzQlFy0SM0U8Hx/8QAFQEBAQAAAAAAAAAAAAAAAAAAAAH/xAAUEQEAAAAAAAAAAAAAAAAAAAAA/9oADAMBAAIRAxEAPwD6oAqAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAPK7qKbXanb9o6weozrmtqq7ERHrLym/XPXVPngGsMj4tUfVV5y7p1NdP1Tx2g1BRo10/XTHCcLtMxVGadvh1AkAAAAAAAAAAAAAAAAAAABFUxTGatmEqGvudKKY3bZ8QRqdXNc4t7I9ZVQUAAAAHdq7NmrNE/qXADWs3YvUZjjH2ejM0VfNvxH32NNAAAAAAAAAAAAAAAAAAAY92v4lyZnfPo1L84s1fjLJAAUAAAAAATRVza4mN0w2WK2YnMIJAAAAAAAAAAAAAAAAAB5an+vV+Mspr3ozaqjun2ZAACgAAAAAA1rE5s0/jHsyWvZjFmn8afZB2AAAAAAAAAAAAAAAAACtrbk27ccycZlnNDlCP4Y/KPaWeAAoAAAAAANHQ3JuUTz5zidnkzmhyfH8Mz3/wCoQWgAAAAAAAAAAAAAAAAAeOqp52nq8M+TLbMxmMTvZuq0/wADHNnOcg8AFAAAAAABqaSnm6envjPmpabT/HzmcYxxaVMc2mIjcgkAAAAAAAAAAAAAAAAABW11HOsZjdMTw6llFUc6MTvBjD0v2ptXMTw74eagAAAADuzb+LciI490Av6KjmWI79qwiIxGxKAAAAAAAAAAAAAAAAAAAACnyjHQpnvn2UV3lGejTHfMqSgAAAAt8ndurwj3VFrk6cXZj7x7SDQAQAAAAAAAAAAAAAAAAARMxTGapx4glTv63E4tRxn9F7WxGy1t756lGZzOZ3g6rrm5Oa5y5BQAAAATTVNFWaZwgBcs63Gy7Ge+P0uxOY2MZcs63Gy7HGP0gvDmiuK4zRMT4OgAAAAAAAAAABxduRapzXOPeVK5rpn5cY9ZBoPK5fpt9qqOG2WbXdqr7VUzx2eTgFy5rv8AHHn+lWu5NyenMy5AAAAFAAAAAAABBNNc0TmmZjwWreumPmRnj2SqANS3qaK+qceOx7MV1TcmjszMcQbAzretqp7fS9JXbN6m9HRnhvgHoAAAA4u3It0TNW71dqPKNW2mOIKt25N2vNf/AByCgAAAAAAAAAAAAAAAAAAAAmiqaKs0ziYQA1dPd+Nbzv3+L1Z2gqxex949YaKAAAz+UPmx4R7yAKoCgAAAAAAAAAAAAAAAAAAAAAD30X9iOPtLTBAAB//Z';
        const socket = io();
        const token = localStorage.getItem('token');
        let currentUserId = null;
        // Cached DOM elements
        const dom = {
            body: document.body,
            toast: document.getElementById('toast'),
            newChatModal: document.getElementById('new-chat-modal'),
            newChatForm: document.getElementById('new-chat-form'),
            newChatCloseBtn: document.querySelector('#new-chat-modal .modal-close'),
            newChatLinks: document.querySelectorAll('[data-modal-toggle="new-chat-modal"]'),
            loader: document.querySelector('.loader'),
            content: document.querySelector('.content'),
            chatList: document.querySelector('.chat-list'),
            chatListContainer: document.querySelector('#chat-list-container'),
            noChats: document.querySelector('.no-chats'),
            backToHomeBtn: document.querySelector('#back-to-home'),
            searchInput: document.querySelector('.search-input'),
            chatIframe: document.querySelector('#chat-iframe'),
            chatIframePlaceholder: document.querySelector('#chat-iframe-placeholder')
        };
        // Token validation
        if (!token) {
            console.error('No token found, redirecting to login');
            showToast('Please log in to view conversations', true);
            window.location.href = '/login';
        } else {
            try {
                const parts = token.split('.');
                if (parts.length !== 3) {
                    throw new Error('Invalid JWT format');
                }
                const payload = JSON.parse(atob(parts[1]));
                currentUserId = payload._id || payload.userId;
                if (!currentUserId) {
                    throw new Error('User ID not found in token payload');
                }
                console.log('User connected with ID:', currentUserId);
                socket.emit('user-connected', currentUserId);
            } catch (error) {
                console.error('Error parsing token:', error.message);
                showToast('Invalid token. Please log in again.', true);
                window.location.href = '/login';
            }
        }
        // Socket.IO error handling
        socket.on('connect_error', () => {
            showToast('Failed to connect to server. Retrying...', true);
            setTimeout(() => socket.connect(), 3000);
        });
        socket.on('disconnect', () => {
            showToast('Disconnected from server.', true);
        });
        function showToast(message, isError = false) {
            if (!dom.toast) {
                console.error('Toast element not found');
                return;
            }
            dom.toast.textContent = message;
            dom.toast.className = `toast fixed bottom-4 right-4 px-4 py-2 rounded-lg shadow-lg z-40 ${isError ? 'bg-red-500' : 'bg-green-500'} text-white`;
            dom.toast.style.display = 'block';
            setTimeout(() => {
                dom.toast.style.opacity = '0';
                setTimeout(() => {
                    dom.toast.style.display = 'none';
                    dom.toast.style.opacity = '1';
                }, 300);
            }, 3000);
        }
        function formatRelativeTime(date) {
            const now = new Date();
            const diffMs = now - new Date(date);
            const diffSeconds = Math.floor(diffMs / 1000);
            const diffMinutes = Math.floor(diffSeconds / 60);
            const diffHours = Math.floor(diffMinutes / 60);
            const diffDays = Math.floor(diffHours / 24);
            const diffWeeks = Math.floor(diffDays / 7);
            if (diffSeconds < 60) return `${diffSeconds} second${diffSeconds === 1 ? '' : 's'} ago`;
            if (diffMinutes < 60) return `${diffMinutes} minute${diffMinutes === 1 ? '' : 's'} ago`;
            if (diffHours < 24) return `${diffHours} hour${diffHours === 1 ? '' : 's'} ago`;
            if (diffDays < 7) return `${diffDays} day${diffDays === 1 ? '' : 's'} ago`;
            if (diffWeeks < 4) return `${diffWeeks} week${diffWeeks === 1 ? '' : 's'} ago`;
            return new Date(date).toLocaleDateString();
        }
        async function fetchChats(retries = 3, delay = 1000) {
            console.log('Fetching chats...');
            if (!navigator.onLine) {
                showToast('You are offline. Please check your connection.', true);
                return [];
            }
            const timeout = setTimeout(() => {
                console.error('fetchChats timed out');
                showToast('Failed to load chats due to timeout', true);
                return [];
            }, 10000);
            for (let attempt = 1; attempt <= retries; attempt++) {
                try {
                    const response = await fetch('/api/chats', {
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    });
                    const chats = await response.json();
                    clearTimeout(timeout);
                    if (!response.ok) {
                        throw new Error(chats.error || `Failed to fetch conversations (status: ${response.status})`);
                    }
                    console.log('Chats fetched:', chats);
                    return chats;
                } catch (error) {
                    console.error(`Fetch chats attempt ${attempt} failed:`, error.message);
                    if (attempt === retries) {
                        clearTimeout(timeout);
                        showToast(error.message, true);
                        return [];
                    }
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }
        async function fetchChatById(chatId) {
            try {
                const response = await fetch(`/api/chats/${chatId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const chat = await response.json();
                if (!response.ok) {
                    throw new Error(chat.error || `Failed to fetch chat ${chatId} (status: ${response.status})`);
                }
                console.log('Chat fetched by ID:', chat);
                return chat;
            } catch (error) {
                console.error('Fetch chat by ID error:', error.message);
                showToast(error.message, true);
                return null;
            }
        }
        async function renderChats(chats) {
            if (!dom.chatListContainer || !dom.noChats) {
                console.error('Chat list container or no-chats element not found');
                showToast('Failed to initialize chat list', true);
                return;
            }
            dom.chatListContainer.innerHTML = '';
            dom.noChats.classList.add('hidden');
            // Hide placeholder on mobile if chats exist
            if (chats.length > 0 && window.innerWidth < 768) {
                dom.chatIframePlaceholder.style.display = 'none';
            } else if (window.innerWidth >= 768) {
                dom.chatIframePlaceholder.style.display = 'flex';
            }
            if (chats.length === 0) {
                dom.noChats.classList.remove('hidden');
                feather.replace();
                return;
            }
            const chatMap = new Map();
            chats.forEach(chat => {
                if (!chat.recipient || !chat.recipient._id || !chat.recipient.name || !chat.lastMessage || !chat.updatedAt) {
                    console.warn('Incomplete chat data, skipping:', chat);
                    return;
                }
                const recipientId = chat.recipient._id;
                if (!chatMap.has(recipientId) || new Date(chatMap.get(recipientId).updatedAt) < new Date(chat.updatedAt)) {
                    chatMap.set(recipientId, chat);
                }
            });
            const deduplicatedChats = Array.from(chatMap.values());
            console.log('Deduplicated chats:', deduplicatedChats);
            for (const chat of deduplicatedChats) {
                const chatCard = document.createElement('div');
                chatCard.className = 'chat-list-item flex items-center p-3 rounded-lg cursor-pointer';
                chatCard.dataset.id = chat._id;
                chatCard.dataset.name = chat.recipient.name;
                chatCard.dataset.image = chat.recipient.profilePicture || defaultProfileImage;
                chatCard.dataset.lastMessage = chat.lastMessage;
                chatCard.dataset.time = formatRelativeTime(chat.updatedAt);
                chatCard.dataset.userId = chat.recipient._id;
                chatCard.dataset.postId = chat.postId || '';
                chatCard.dataset.isOnline = chat.recipient.isOnline || false;
                chatCard.tabIndex = 0;
                chatCard.setAttribute('role', 'button');
                chatCard.setAttribute('aria-label', `Open chat with ${chat.recipient.name}`);
                chatCard.innerHTML = `
                    <div class="relative mr-3">
                        <img src="${chat.recipient.profilePicture || defaultProfileImage}" alt="${chat.recipient.name} profile picture" class="w-12 h-12 rounded-full object-cover" loading="lazy" onerror="this.src='${defaultProfileImage}'; this.nextElementSibling.classList.remove('hidden');">
                        <span class="no-profile-image ${chat.recipient.profilePicture ? 'hidden' : ''}">No profile picture</span>
                        <span class="${chat.recipient.isOnline ? 'absolute bottom-0 right-0 w-3 h-3 bg-green-500 rounded-full border-2 border-gray-900' : 'hidden'}"></span>
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="flex justify-between items-center">
                            <h3 class="font-semibold text-sm truncate">${chat.recipient.name}</h3>
                            <span class="text-xs text-gray-500">${formatRelativeTime(chat.updatedAt)}</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <p class="text-sm text-gray-400 truncate">${chat.lastMessage}</p>
                            ${chat.unreadCount > 0 ? `<div class="unread-badge text-white">${chat.unreadCount}</div>` : ''}
                        </div>
                    </div>
                `;
                dom.chatListContainer.appendChild(chatCard);
            }
            feather.replace();
        }
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('DOM loaded, initializing chat list');
            console.log('loader:', dom.loader);
            console.log('content:', dom.content);
            console.log('chatList:', dom.chatList);
            console.log('chatIframe:', dom.chatIframe);
            feather.replace();
            if (!dom.loader || !dom.content || !dom.chatList || !dom.chatIframe || !dom.chatIframePlaceholder) {
                console.error('Critical elements not found');
                showToast('Page initialization failed', true);
                return;
            }
            dom.body.classList.add('loading');
            const chats = await fetchChats();
            await renderChats(chats);
            dom.body.classList.remove('loading');
            dom.loader.style.display = 'none';
            dom.content.style.display = 'block';
            initChatFunctionality();
        });
        function initChatFunctionality() {
            dom.chatList?.addEventListener('click', async (e) => {
                const card = e.target.closest('.chat-list-item');
                if (card) {
                    const chatId = card.dataset.id;
                    if (window.innerWidth >= 768) {
                        // PC: Load chat in iframe
                        dom.chatIframe.src = `/messages.html?chatId=${chatId}`;
                        dom.chatIframe.style.display = 'block';
                        dom.chatIframePlaceholder.style.display = 'none';
                        dom.chatList.classList.remove('hidden');
                    } else {
                        // Mobile: Redirect to messages.html
                        window.location.href = `/messages.html?chatId=${chatId}`;
                        dom.chatList.classList.add('hidden');
                    }
                    // Highlight selected chat
                    dom.chatListContainer.querySelectorAll('.chat-list-item').forEach(item => {
                        item.classList.remove('active');
                    });
                    card.classList.add('active');
                }
            });
            dom.chatList?.addEventListener('keydown', async (e) => {
                if (e.key === 'Enter' || e.key === ' ') {
                    const card = e.target.closest('.chat-list-item');
                    if (card) {
                        e.preventDefault();
                        const chatId = card.dataset.id;
                        if (window.innerWidth >= 768) {
                            dom.chatIframe.src = `/messages.html?chatId=${chatId}`;
                            dom.chatIframe.style.display = 'block';
                            dom.chatIframePlaceholder.style.display = 'none';
                            dom.chatList.classList.remove('hidden');
                        } else {
                            window.location.href = `/messages.html?chatId=${chatId}`;
                            dom.chatList.classList.add('hidden');
                        }
                        dom.chatListContainer.querySelectorAll('.chat-list-item').forEach(item => {
                            item.classList.remove('active');
                        });
                        card.classList.add('active');
                    }
                }
            });
            socket.on('new-chat', async (chat) => {
                console.log('New chat received:', chat);
                const chats = await fetchChats();
                await renderChats(chats);
                if (window.innerWidth >= 768) {
                    dom.chatIframe.src = `/messages.html?chatId=${chat._id}`;
                    dom.chatIframe.style.display = 'block';
                    dom.chatIframePlaceholder.style.display = 'none';
                } else {
                    window.location.href = `/messages.html?chatId=${chat._id}`;
                }
            });
            socket.on('new-message', async ({ chatId }) => {
                const chats = await fetchChats();
                await renderChats(chats);
                if (window.innerWidth >= 768 && dom.chatIframe.src.includes(`chatId=${chatId}`)) {
                    // Reload iframe to reflect new message
                    dom.chatIframe.src = dom.chatIframe.src;
                }
            });
            socket.on('user-status-update', ({ userId, isOnline }) => {
                const chatCards = dom.chatListContainer.querySelectorAll('.chat-list-item');
                chatCards.forEach(card => {
                    if (card.dataset.userId === userId) {
                        card.dataset.isOnline = isOnline;
                        const onlineIndicator = card.querySelector('.absolute.bottom-0.right-0');
                        if (onlineIndicator) {
                            onlineIndicator.classList.toggle('hidden', !isOnline);
                        }
                    }
                });
            });
        }
        function closeNewChatModal() {
            if (dom.newChatModal) {
                dom.newChatModal.classList.remove('active');
                setTimeout(() => {
                    dom.newChatModal.style.display = 'none';
                    dom.newChatModal.setAttribute('aria-hidden', 'true');
                }, 300);
            }
        }
        dom.newChatLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                if (dom.newChatModal) {
                    dom.newChatModal.style.display = 'flex';
                    dom.newChatModal.classList.add('active');
                    dom.newChatModal.setAttribute('aria-hidden', 'false');
                    dom.newChatForm.querySelector('#chat-recipient')?.focus();
                }
            });
        });
        dom.newChatCloseBtn?.addEventListener('click', closeNewChatModal);
        dom.newChatModal?.addEventListener('click', (e) => {
            if (e.target === dom.newChatModal) {
                closeNewChatModal();
            }
        });
        dom.newChatForm?.addEventListener('submit', async (e) => {
            e.preventDefault();
            const recipient = dom.newChatForm.querySelector('#chat-recipient')?.value.trim();
            if (!recipient) {
                showToast('Please enter a recipient name', true);
                return;
            }
            try {
                const response = await fetch('/api/chats', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ recipient })
                });
                const data = await response.json();
                if (!response.ok) {
                    throw new Error(data.error || 'Failed to start chat');
                }
                closeNewChatModal();
                dom.newChatForm.reset();
                showToast('Chat started successfully!');
                const chats = await fetchChats();
                await renderChats(chats);
                if (window.innerWidth >= 768) {
                    dom.chatIframe.src = `/messages.html?chatId=${data._id}`;
                    dom.chatIframe.style.display = 'block';
                    dom.chatIframePlaceholder.style.display = 'none';
                } else {
                    window.location.href = `/messages.html?chatId=${data._id}`;
                }
            } catch (error) {
                console.error('Chat creation error:', error.message);
                showToast(error.message, true);
            }
        });
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && dom.newChatModal?.classList.contains('active')) {
                closeNewChatModal();
            }
        });
        // Update placeholder visibility on window resize
        window.addEventListener('resize', () => {
            const hasChats = dom.chatListContainer.children.length > 0;
            if (hasChats && window.innerWidth < 768) {
                dom.chatIframePlaceholder.style.display = 'none';
            } else if (window.innerWidth >= 768) {
                dom.chatIframePlaceholder.style.display = 'flex';
            }
        });
    </script>
</body>
</html>