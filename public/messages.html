<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="Chat with friends and connections on Coded Signals">
    <title>Coded Signals - Messages</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    <script src="/socket.io/socket.io.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #FF4DA6;
            --secondary: #FF77C6;
            --bg-primary: #0f172a;
            --bg-chat: #111827;
            --bubble-received: #1f2937;
            --border: #334155;
            --text: #e2e8f0;
            --text-muted: #94a3b8;
        }
        html, body { margin:0; padding:0; height:100%; background:var(--bg-primary); font-family:'Inter',sans-serif; color:#fff; overscroll-behavior:none; }
        .top-nav { position:fixed; top:0; left:0; right:0; z-index:50; background:rgba(15,23,42,0.95); backdrop-filter:blur(12px); border-bottom:1px solid var(--border); padding:12px 16px; }
        .input-bar { position:fixed; bottom:0; left:0; right:0; z-index:50; background:rgba(15,23,42,0.95); backdrop-filter:blur(12px); border-top:1px solid var(--border); padding:12px 16px; padding-bottom:calc(12px + env(safe-area-inset-bottom)); }
        .messages-area { padding-top:80px; padding-bottom:100px; background:var(--bg-chat); min-height:100vh; }
        .messages-container { display:flex; flex-direction:column; gap:12px; max-width:900px; margin:0 auto; padding:0 16px; }
        .chat-bubble { max-width:72%; padding:11px 16px; border-radius:18px; position:relative; word-break:break-word; font-size:15px; line-height:1.4; animation:fadeIn 0.25s ease-out; }
        .sent { 
            background: linear-gradient(135deg, var(--primary), var(--secondary)); 
            color:white; align-self:flex-end; border-bottom-right-radius:4px; 
        }
        .received { background:var(--bubble-received); color:var(--text); align-self:flex-start; border:1px solid var(--border); border-bottom-left-radius:4px; }
        .sent::after { content:''; position:absolute; bottom:0; right:-7px; width:12px; height:16px; background:var(--primary); border-bottom-left-radius:14px; }
        .received::after { content:''; position:absolute; bottom:0; left:-7px; width:12px; height:16px; background:var(--bubble-received); border-bottom-right-radius:14px; box-shadow:inset 0 -4px 0 var(--border); }
        .timestamp { font-size:11px; opacity:0.75; margin-top:5px; text-align:right; }
        .read-receipt { font-size:10px; margin-left:4px; }
        .read { color:#60a5fa; }
        #chat-input { background:#1e293b; border:1px solid #334155; border-radius:28px; padding:13px 56px 13px 18px; color:white; resize:none; max-height:130px; font-size:16px; }
        #chat-input:focus { outline:none; border-color:var(--primary); box-shadow:0 0 0 3px rgba(255,77,166,0.3); }
        .send-btn { background: linear-gradient(135deg, var(--primary), var(--secondary)); }
        .date-separator { align-self:center; background:#1f2937; color:var(--text-muted); font-size:12px; padding:6px 16px; border-radius:32px; margin:16px 0; }
        @keyframes fadeIn { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:none; } }
    </style>
</head>
<body class="flex flex-col h-screen">

    <header class="top-nav">
        <div class="flex items-center justify-between">
            <div class="flex items-center gap-4 flex-1 min-w-0">
                <img id="header-image" src="" alt="" class="w-11 h-11 rounded-full object-cover">
                <div class="min-w-0">
                    <h2 id="header-title" class="font-semibold text-lg truncate gradient-text"></h2>
                    <p id="typing-indicator" class="text-sm text-slate-400"></p>
                </div>
            </div>
            <div class="flex gap-3">
                <button class="p-2.5 hover:bg-slate-800 rounded-full"><i data-feather="phone" class="w-5 h-5"></i></button>
                <button class="p-2.5 hover:bg-slate-800 rounded-full"><i data-feather="video" class="w-5 h-5"></i></button>
                <button class="p-2.5 hover:bg-slate-800 rounded-full"><i data-feather="more-vertical" class="w-5 h-5"></i></button>
            </div>
        </div>
    </header>

    <div id="toast" class="fixed bottom-24 left-1/2 -translate-x-1/2 px-6 py-3 rounded-full bg-green-600 text-white z-50 hidden shadow-xl"></div>

    <main class="flex-1 overflow-y-auto messages-area">
        <div id="messages-container" class="messages-container"></div>
    </main>

    <div class="input-bar">
        <form id="chat-form" class="flex items-end gap-3 max-w-4xl mx-auto">
            <button type="button" class="text-slate-400 hover:text-white"><i data-feather="plus-circle" class="w-7 h-7"></i></button>
            <div class="flex-1 relative">
                <textarea id="chat-input" rows="1" placeholder="Message..." class="w-full"></textarea>
                <button type="button" id="emoji-button" class="absolute right-4 bottom-3.5 text-slate-400 hover:text-white"><i data-feather="smile" class="w-6 h-6"></i></button>
            </div>
            <button type="submit" class="p-3.5 send-btn rounded-full hover:opacity-90 transition"><i data-feather="send" class="w-6 h-6"></i></button>
        </form>
    </div>

    <script>
        const API_URL = 'https://coded-mbkz.onrender.com';
        const defaultProfileImage = 'data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/2wCEAAkGBxAHBhAPBw4PDxUPEA8VEBgQDw8QDg8PFRMWFhcRFRMYHSgiGBolHRUVITEhJSktLi4uFx8zODcsNygtLisBCgoKDQ0NFQ0NFSsZFRkrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrK//AABEIAOEA4QMBIgACEQEDEQH/xAAaAAEAAwEBAQAAAAAAAAAAAAAAAQQFAgMH/8QAMRABAAEDAQMKBgIDAAAAAAAAAAECAxEEIUGBBRIiMTJhcZGhsRMzQlFy0SM0U8Hx/8QAFQEBAQAAAAAAAAAAAAAAAAAAAAH/xAAUEQEAAAAAAAAAAAAAAAAAAAAA/9oADAMBAAIRAxEAPwD6oAqAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAPK7qKbXanb9o6weozrmtqq7ERHrLym/XPXVPngGsMj4tUfVV5y7p1NdP1Tx2g1BRo10/XTHCcLtMxVGadvh1AkAAAAAAAAAAAAAAAAAAABFUxTGatmEqGvudKKY3bZ8QRqdXNc4t7I9ZVQUAAAAHdq7NmrNE/qXADWs3YvUZjjH2ejM0VfNvxH32NNAAAAAAAAAAAAAAAAAAAY92v4lyZnfPo1L84s1fjLJAAUAAAAAATRVza4mN0w2WK2YnMIJAAAAAAAAAAAAAAAAAB5an+vV+Mspr3ozaqjun2ZAACgAAAAAA1rE5s0/jHsyWvZjFmn8afZB2AAAAAAAAAAAAAAAAACtrbk27ccycZlnNDlCP4Y/KPaWeAAoAAAAAANHQ3JuUTz5zidnkzmhyfH8Mz3/wCoQWgAAAAAAAAAAAAAAAAAeOqp52nq8M+TLbMxmMTvZuq0/wADHNnOcg8AFAAAAAABqaSnm6envjPmpabT/HzmcYxxaVMc2mIjcgkAAAAAAAAAAAAAAAAABW11HOsZjdMTw6llFUc6MTvBjD0v2ptXMTw74eagAAAADuzb+LciI490Av6KjmWI79qwiIxGxKAAAAAAAAAAAAAAAAAAAACnyjHQpnvn2UV3lGejTHfMqSgAAAAt8ndurwj3VFrk6cXZj7x7SDQAQAAAAAAAAAAAAAAAAARMxTGapx4glTv63E4tRxn9F7WxGy1t756lGZzOZ3g6rrm5Oa5y5BQAAAATTVNFWaZwgBcs63Gy7Ge+P0uxOY2MZcs63Gy7HGP0gvDmiuK4zRMT4OgAAAAAAAAAABxduRapzXOPeVK5rpn5cY9ZBoPK5fpt9qqOG2WbXdqr7VUzx2eTgFy5rv8AHHn+lWu5NyenMy5AAAAFAAAAAAABBNNc0TmmZjwWreumPmRnj2SqANS3qaK+qceOx7MV1TcmjszMcQbAzretqp7fS9JXbN6m9HRnhvgHoAAAA4u3It0TNW71dqPKNW2mOIKt25N2vNf/AByCgAAAAAAAAAAAAAAAAAAAAmiqaKs0ziYQA1dPd+Nbzv3+L1Z2gqxex949YaKAAAz+UPmx4R7yAKoCgAAAAAAAAAAAAAAAAAAAAAD30X9iOPtLTBAAB//Z';

        const socket = io(API_URL);
        const token = localStorage.getItem('token');
        let currentUserId = null;

        const dom = {
            body: document.body,
            toast: document.getElementById('toast'),
            headerImage: document.getElementById('header-image'),
            headerTitle: document.getElementById('header-title'),
            typingIndicator: document.getElementById('typing-indicator'),
            messagesContainer: document.getElementById('messages-container'),
            chatForm: document.getElementById('chat-form'),
            chatInput: document.getElementById('chat-input'),
            emojiButton: document.getElementById('emoji-button')
        };

        if (!token) {
            localStorage.removeItem('token');
            showToast('Please log in to view conversations', true);
            window.location.href = '/login.html';
        } else {
            try {
                const parts = token.split('.');
                if (parts.length !== 3) throw new Error('Invalid JWT format');
                const payload = JSON.parse(atob(parts[1]));
                currentUserId = payload._id || payload.userId;
                if (!currentUserId) throw new Error('User ID not found');
                socket.emit('user-connected', currentUserId);
            } catch (error) {
                localStorage.removeItem('token');
                showToast('Invalid token. Please log in again.', true);
                window.location.href = '/login.html';
            }
        }

        function showToast(message, isError = false) {
            dom.toast.textContent = message;
            dom.toast.className = `fixed bottom-24 left-1/2 -translate-x-1/2 px-6 py-3 rounded-full shadow-xl z-50 ${isError ? 'bg-red-600' : 'bg-green-600'} text-white`;
            dom.toast.style.display = 'block';
            setTimeout(() => { dom.toast.style.opacity = '0'; setTimeout(() => { dom.toast.style.display = 'none'; dom.toast.style.opacity = '1'; }, 300); }, 3000);
        }

        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func(...args), wait);
            };
        }

        function formatDateSeparator(date) {
            const today = new Date();
            const messageDate = new Date(date);
            const isToday = messageDate.toDateString() === today.toDateString();
            const isYesterday = new Date(today.setDate(today.getDate() - 1)).toDateString() === messageDate.toDateString();
            if (isToday) return 'Today';
            if (isYesterday) return 'Yesterday';
            return messageDate.toLocaleDateString([], { month: 'short', day: 'numeric' });
        }

        function formatRelativeTime(date) {
            const now = new Date();
            const diffMs = now - new Date(date);
            const diffSeconds = Math.floor(diffMs / 1000);
            const diffMinutes = Math.floor(diffSeconds / 60);
            const diffHours = Math.floor(diffMinutes / 60);
            const diffDays = Math.floor(diffHours / 24);
            if (diffSeconds < 60) return `${diffSeconds}s ago`;
            if (diffMinutes < 60) return `${diffMinutes}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            if (diffDays < 7) return `${diffDays}d ago`;
            return new Date(date).toLocaleDateString();
        }

        async function fetchMessages(chatId) {
            try {
                const response = await fetch(`${API_URL}/api/chats/${chatId}/messages`, { headers: { 'Authorization': `Bearer ${token}` } });
                if (!response.ok) throw new Error('Failed to fetch messages');
                return await response.json();
            } catch (error) {
                showToast('Failed to load messages', true);
                return { messages: [], error: true };
            }
        }

        async function fetchPostContent(postId) { /* your original function */ return ''; }

        async function fetchChatById(chatId) {
            try {
                const response = await fetch(`${API_URL}/api/chats/${chatId}`, { headers: { 'Authorization': `Bearer ${token}` } });
                if (!response.ok) throw new Error('Chat not found');
                return await response.json();
            } catch (error) {
                showToast(error.message, true);
                return null;
            }
        }

        async function renderMessages(data, recipientName) {
            dom.messagesContainer.innerHTML = '';
            if (data.error) return;

            let lastDate = null;
            data.messages.forEach(message => {
                const messageDate = new Date(message.createdAt).toDateString();
                if (lastDate !== messageDate) {
                    const sep = document.createElement('div');
                    sep.className = 'date-separator';
                    sep.textContent = formatDateSeparator(message.createdAt);
                    dom.messagesContainer.appendChild(sep);
                    lastDate = messageDate;
                }

                const bubble = document.createElement('div');
                bubble.className = `chat-bubble ${message.isSent ? 'sent' : 'received'}`;
                const time = new Date(message.createdAt).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                const readStatus = message.status === 'read' ? '✓✓' : '✓';
                bubble.innerHTML = `
                    <div class="text-base">${message.text}</div>
                    <div class="timestamp flex items-center justify-end gap-1 mt-1">
                        <span>${time}</span>
                        ${message.isSent ? `<span class="read-receipt ${message.status === 'read' ? 'read' : ''}">${readStatus}</span>` : ''}
                    </div>`;
                dom.messagesContainer.appendChild(bubble);
            });
            dom.messagesContainer.scrollTop = dom.messagesContainer.scrollHeight;
        }

        async function selectChat(chat) {
            dom.headerImage.src = chat.recipient.profilePicture || defaultProfileImage;
            dom.headerImage.onerror = () => dom.headerImage.src = defaultProfileImage;
            dom.headerTitle.textContent = chat.recipient.name;
            dom.headerTitle.classList.add('gradient-text');
            dom.typingIndicator.textContent = chat.recipient.isOnline ? 'Online' : `Last seen ${formatRelativeTime(chat.recipient.lastSeen || new Date())}`;

            const data = await fetchMessages(chat._id);
            await renderMessages(data, chat.recipient.name);
            dom.chatInput.focus();
        }

        document.addEventListener('DOMContentLoaded', async () => {
            feather.replace();
            const chatId = new URLSearchParams(window.location.search).get('chatId');
            if (!chatId) { showToast('No chat selected', true); window.location.href = '/chat.html'; return; }

            const chat = await fetchChatById(chatId);
            if (chat) await selectChat({ _id: chat._id, recipient: chat.recipient, postId: chat.postId });
            else { showToast('Chat not found', true); setTimeout(() => window.location.href = '/chat.html', 3000); }

            initChatFunctionality();
        });

        function initChatFunctionality() {
            dom.chatInput.addEventListener('input', () => {
                dom.chatInput.style.height = 'auto';
                dom.chatInput.style.height = `${Math.min(dom.chatInput.scrollHeight, 130)}px`;
            });

            dom.chatForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const message = dom.chatInput.value.trim();
                const chatId = new URLSearchParams(window.location.search).get('chatId');
                if (!message || !chatId) return;

                try {
                    const response = await fetch(`${API_URL}/api/chats/${chatId}/messages`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify({ text: message })
                    });
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.error || 'Failed');

                    const bubble = document.createElement('div');
                    bubble.className = 'chat-bubble sent';
                    bubble.innerHTML = `<div class="text-base">${data.text}</div><div class="timestamp flex items-center justify-end gap-1 mt-1"><span>${new Date(data.createdAt).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</span><span class="read-receipt">✓</span></div>`;
                    dom.messagesContainer.appendChild(bubble);
                    dom.messagesContainer.scrollTop = dom.messagesContainer.scrollHeight;
                    socket.emit('new-message', { chatId, message: { ...data, status: 'sent' } });
                    dom.chatInput.value = '';
                    dom.chatInput.style.height = 'auto';
                } catch (err) { showToast(err.message, true); }
            });

            socket.on('new-message', ({ chatId, message }) => {
                if (new URLSearchParams(window.location.search).get('chatId') === chatId) {
                    const bubble = document.createElement('div');
                    bubble.className = 'chat-bubble received';
                    bubble.innerHTML = `<div class="text-base">${message.text}</div><div class="timestamp mt-1">${new Date(message.createdAt).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</div>`;
                    dom.messagesContainer.appendChild(bubble);
                    dom.messagesContainer.scrollTop = dom.messagesContainer.scrollHeight;
                }
            });

            // typing & status events remain unchanged
        }
    </script>
</body>
</html>