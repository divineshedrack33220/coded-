<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="View user profile on DarkPulse Connect">
    <title>Coded Signal - User Profile</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Inter:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.1);
        }
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(to bottom, #FF4DA6, #FF77C6);
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(to bottom, #FF77C6, #FF4DA6);
        }

        /* Card hover effect */
        .profile-card, .post-card {
            transition: all 0.3s ease;
        }
        .profile-card:hover, .post-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(255, 77, 166, 0.2);
        }

        /* Gradient text */
        .gradient-text {
            background: linear-gradient(to right, #FF4DA6, #FF77C6);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        /* Profile card styles */
        .profile-card, .post-card {
            background: rgba(31, 41, 55, 0.7);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 1rem;
        }

        .btn-gradient {
            background: linear-gradient(to right, #FF4DA6, #FF77C6);
            transition: all 0.3s ease;
        }
        .btn-gradient:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(255, 77, 166, 0.3);
        }

        /* Media gallery grid */
        .media-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }
        @media (min-width: 768px) {
            .media-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        /* Star rating */
        .star-rating .star {
            cursor: pointer;
            color: #d1d5db;
            transition: color 0.2s ease;
        }
        .star-rating .star.filled {
            color: #FFD700;
        }
        .star-rating .star:hover,
        .star-rating .star:hover ~ .star {
            color: #FFD700;
        }

        /* Loading skeleton */
        .skeleton {
            background: linear-gradient(90deg, rgba(31, 41, 55, 0.1) 25%, rgba(31, 41, 55, 0.3) 50%, rgba(31, 41, 55, 0.1) 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite linear;
        }
        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .loader {
            width: 50px;
            aspect-ratio: 1;
            display: grid;
            border: 4px solid #0000;
            border-radius: 50%;
            border-right-color: #FF4DA6;
            animation: l15 1s infinite linear;
            margin: 2rem auto;
        }
        .loader::before,
        .loader::after {    
            content: "";
            grid-area: 1/1;
            margin: 2px;
            border: inherit;
            border-radius: 50%;
            animation: l15 2s infinite;
        }
        .loader::after {
            margin: 8px;
            animation-duration: 3s;
        }
        @keyframes l15 { 
            100% { transform: rotate(1turn) }
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 font-sans min-h-screen flex flex-col">
    <div class="relative z-10">
        <!-- Header Section -->
        <nav class="sticky top-0 z-20 bg-gray-900/80 border-b border-gray-800 py-4 px-6 backdrop-blur-sm">
            <div class="container mx-auto flex items-center justify-between">
                <a href="/home.html" class="text-pink-400 hover:text-pink-500">
                    <i data-feather="arrow-left" class="w-6 h-6"></i>
                </a>
                <h1 id="profile-name-header" class="text-xl font-bold gradient-text">User Profile</h1>
                <button class="text-gray-400 hover:text-pink-400" aria-label="More options">
                    <i data-feather="more-vertical" class="w-6 h-6"></i>
                </button>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="flex-1 py-8 container mx-auto px-4">
            <!-- Loading Overlay -->
            <div id="loading-overlay" class="fixed inset-0 bg-gray-900/80 z-50 flex items-center justify-center hidden">
                <div class="text-center">
                    <div class="loader"></div>
                </div>
            </div>

            <!-- Alert Message -->
            <div id="alert" class="hidden p-4 rounded-lg text-sm mb-6 bg-gray-800 border border-pink-900/50"></div>

            <!-- Profile Banner & Picture -->
            <div class="relative">
                <div class="h-48 bg-gradient-to-r from-pink-500 to-pink-300 rounded-t-xl"></div>
                <div class="flex justify-center -mt-16">
                    <img id="profile-picture" src="" alt="Profile picture" class="w-28 h-28 rounded-full border-4 border-gray-900 object-cover">
                </div>
                <div class="flex justify-center gap-4 mt-4">
                    <button id="add-connection-btn" class="btn-gradient text-white px-6 py-2 rounded-full">Add Connection</button>
                    <button id="message-btn" class="bg-gray-700 text-gray-300 px-6 py-2 rounded-full hover:bg-gray-600">Message</button>
                </div>
                <!-- Star Rating -->
                <div class="flex justify-center gap-2 mt-4 star-rating">
                    <i data-feather="star" class="w-6 h-6 star" data-value="1"></i>
                    <i data-feather="star" class="w-6 h-6 star" data-value="2"></i>
                    <i data-feather="star" class="w-6 h-6 star" data-value="3"></i>
                    <i data-feather="star" class="w-6 h-6 star" data-value="4"></i>
                    <i data-feather="star" class="w-6 h-6 star" data-value="5"></i>
                </div>
            </div>

            <!-- Basic Info -->
            <div class="profile-card mt-6 p-6">
                <h2 id="profile-name" class="text-xl font-bold text-white">Loading...</h2>
                <p id="profile-age-location" class="text-sm text-gray-400">N/A</p>
                <p id="profile-role" class="text-sm text-gray-300">N/A</p>
            </div>

            <!-- Details Section -->
            <div class="profile-card mt-6 p-6">
                <h3 class="text-lg font-semibold gradient-text mb-4">Details</h3>
                <div class="space-y-3">
                    <div class="flex items-center gap-3 border-b border-gray-700 pb-2">
                        <i data-feather="mail" class="w-5 h-5 text-pink-400"></i>
                        <p><span class="text-gray-400">Email:</span> <span id="profile-email">N/A</span></p>
                    </div>
                    <div class="flex items-center gap-3 border-b border-gray-700 pb-2">
                        <i data-feather="phone" class="w-5 h-5 text-pink-400"></i>
                        <p><span class="text-gray-400">Phone:</span> <span id="profile-phone">N/A</span></p>
                    </div>
                    <div class="flex items-center gap-3 border-b border-gray-700 pb-2">
                        <i data-feather="user" class="w-5 h-5 text-pink-400"></i>
                        <p><span class="text-gray-400">Gender:</span> <span id="profile-gender">N/A</span></p>
                    </div>
                    <div class="flex items-center gap-3 border-b border-gray-700 pb-2">
                        <i data-feather="file-text" class="w-5 h-5 text-pink-400"></i>
                        <p><span class="text-gray-400">Bio:</span> <span id="profile-bio">N/A</span></p>
                    </div>
                    <div class="flex items-center gap-3">
                        <i data-feather="calendar" class="w-5 h-5 text-pink-400"></i>
                        <p><span class="text-gray-400">Joined:</span> <span id="profile-joined">N/A</span></p>
                    </div>
                </div>
            </div>

            <!-- Stats & Activity -->
            <div class="flex gap-4 mt-6">
                <div class="profile-card flex-1 p-4 text-center">
                    <p class="text-2xl font-bold text-white" id="profile-connections">0</p>
                    <p class="text-sm text-gray-400">Connections</p>
                </div>
                <div class="profile-card flex-1 p-4 text-center">
                    <p class="text-2xl font-bold text-white" id="profile-posts">0</p>
                    <p class="text-sm text-gray-400">Posts</p>
                </div>
            </div>

            <!-- Media Gallery -->
            <div class="mt-6">
                <h3 class="text-lg font-semibold gradient-text mb-4">Additional Images</h3>
                <div id="media-grid" class="media-grid"></div>
                <div id="no-media" class="hidden text-center text-gray-400 mt-4">No additional images.</div>
            </div>

            <!-- Posts Preview -->
            <div class="mt-6">
                <h3 id="posts-title" class="text-lg font-semibold gradient-text mb-4">Posts</h3>
                <div id="posts-grid" class="space-y-4"></div>
                <div id="no-posts" class="hidden text-center text-gray-400 mt-4">No posts yet.</div>
            </div>
        </main>
    </div>
<script>
  // Default profile image
  const defaultProfileImage = 'data:image/jpeg;base64,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';

  // Show alert message
  function showAlert(message, type = 'error') {
    const alertBox = document.getElementById('alert');
    if (alertBox) {
      alertBox.classList.remove('hidden');
      alertBox.className = `p-4 rounded-lg text-sm mb-6 ${type === 'error' ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}`;
      alertBox.textContent = message;
      setTimeout(() => {
        alertBox.classList.add('hidden');
      }, 5000);
    } else {
      console.error('Alert box element not found');
    }
  }

  // Fetch user profile data with retry
  async function fetchUserProfile(userId, retries = 3, delay = 1000) {
    console.log('Fetching profile for userId:', userId, 'Retries left:', retries);
    const token = localStorage.getItem('token');
    if (!token) {
      console.error('No token found in localStorage');
      showAlert('Please log in to view profiles', 'error');
      window.location.href = '/login.html';
      return null;
    }
    try {
      const response = await fetch(`http://localhost:5000/api/users/${userId}`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      if (response.status === 401 || response.status === 403) {
        console.error('Invalid or expired token');
        showAlert('Session expired. Please log in again.', 'error');
        localStorage.removeItem('token');
        window.location.href = '/login.html';
        return null;
      }
      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.error || `Failed to fetch profile: ${response.status}`);
      }
      const data = await response.json();
      console.log('Raw API response:', JSON.stringify(data, null, 2));
      console.log('Key fields:', { fullName: data.fullName, email: data.email, avatar: data.avatar });
      return data;
    } catch (error) {
      console.error('Fetch profile error:', error.message);
      if (retries > 0) {
        console.log(`Retrying... (${retries} attempts left)`);
        await new Promise(resolve => setTimeout(resolve, delay));
        return fetchUserProfile(userId, retries - 1, delay * 2);
      }
      showAlert('Failed to fetch profile data after retries. Please try again.', 'error');
      return null;
    }
  }

  // Submit rating
  async function submitRating(userId, rating) {
    const token = localStorage.getItem('token');
    if (!token) {
      showAlert('Please log in to rate this user', 'error');
      return;
    }
    try {
      const response = await fetch(`/api/users/${userId}/rate`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ rating })
      });
      const data = await response.json();
      if (!response.ok) {
        throw new Error(data.error || 'Failed to submit rating');
      }
      showAlert(`Rating submitted! Average: ${data.averageRating.toFixed(1)}`, 'success');
      const stars = document.querySelectorAll('.star-rating .star');
      stars.forEach((star, index) => {
        star.classList.toggle('filled', index < Math.round(data.averageRating));
      });
    } catch (error) {
      console.error('Rating submission error:', error.message);
      showAlert(error.message, 'error');
    }
  }

  // Format date
  function formatDate(dateString) {
    if (!dateString) return 'N/A';
    const date = new Date(dateString);
    if (isNaN(date.getTime())) return 'N/A';
    return date.toLocaleDateString('en-US', {
      year: 'numeric',
      month: 'long',
      day: 'numeric'
    });
  }

  // Render profile
  function renderProfile(user) {
    console.log('Starting renderProfile with user data:', { fullName: user.fullName, email: user.email, avatar: user.avatar });
    console.log('Full user data:', JSON.stringify(user, null, 2));
    if (!user) {
      console.warn('No user data provided');
      showAlert('No profile data available.', 'error');
      return;
    }

    const profileAvatar = document.getElementById('profile-picture');
    const profileFullNameHeader = document.getElementById('profile-name-header');
    const profileFullName = document.getElementById('profile-name');
    const profileRoleLocationAge = document.getElementById('profile-age-location');
    const profileRole = document.getElementById('profile-role');
    const profileEmail = document.getElementById('profile-email');
    const profilePhone = document.getElementById('profile-phone');
    const profileGender = document.getElementById('profile-gender');
    const profileBio = document.getElementById('profile-bio');
    const profileJoined = document.getElementById('profile-joined');
    const profileConnections = document.getElementById('profile-connections');
    const profilePosts = document.getElementById('profile-posts');
    const mediaGrid = document.getElementById('media-grid');
    const noMedia = document.getElementById('no-media');
    const postsGrid = document.getElementById('posts-grid');
    const postsTitle = document.getElementById('posts-title');
    const noPosts = document.getElementById('no-posts');

    // Check for missing DOM elements
    console.log('DOM elements:', {
      profileAvatar: !!profileAvatar,
      profileFullNameHeader: !!profileFullNameHeader,
      profileFullName: !!profileFullName,
      profileRoleLocationAge: !!profileRoleLocationAge,
      profileRole: !!profileRole,
      profileEmail: !!profileEmail,
      profilePhone: !!profilePhone,
      profileGender: !!profileGender,
      profileBio: !!profileBio,
      profileJoined: !!profileJoined,
      profileConnections: !!profileConnections,
      profilePosts: !!profilePosts,
      mediaGrid: !!mediaGrid,
      noMedia: !!noMedia,
      postsGrid: !!postsGrid,
      postsTitle: !!postsTitle,
      noPosts: !!noPosts
    });

    if (!profileAvatar || !profileFullNameHeader || !profileFullName || !profileRoleLocationAge || !profileRole ||
        !profileEmail || !profilePhone || !profileGender || !profileBio || !profileJoined ||
        !profileConnections || !profilePosts || !mediaGrid || !noMedia || !postsGrid || !postsTitle || !noPosts) {
      console.error('Profile elements not found');
      showAlert('Error rendering profile: UI elements missing', 'error');
      return;
    }

    // Render profile data sequentially
    try {
      // Name handling: Use fullName if available, else email's first part, else 'Unknown User'
      const emailFirstPart = user.email && typeof user.email === 'string' && user.email.includes('@')
        ? user.email.split('@')[0].trim()
        : null;
      const fullNameValue = typeof user.fullName === 'string' && user.fullName.trim()
        ? user.fullName.trim()
        : emailFirstPart || 'Unknown User';

      // Avatar handling: Use avatar if valid, else first valid image from user.images, else default
      let avatarSrc = user.avatar && user.avatar.trim() ? user.avatar : null;
      if (!avatarSrc && Array.isArray(user.images) && user.images.length > 0) {
        // Find the first valid image in user.images
        const validImage = user.images.find(img => img && typeof img === 'string' && img.trim());
        avatarSrc = validImage ? (validImage.startsWith('http') ? validImage : `http://localhost:5000${validImage}`) : null;
      }
      profileAvatar.src = avatarSrc || defaultProfileImage;
      profileAvatar.alt = `${fullNameValue} profile picture`;
      profileAvatar.onerror = () => {
        console.error('Profile picture failed to load:', user.avatar || avatarSrc);
        profileAvatar.src = defaultProfileImage;
      };
      profileAvatar.onload = () => {
        console.log('Profile picture loaded successfully:', profileAvatar.src);
      };

      profileFullNameHeader.textContent = fullNameValue;
      profileFullName.textContent = fullNameValue;
      console.log('Set fullName:', fullNameValue, 'on elements:', {
        headerText: profileFullNameHeader.textContent,
        nameText: profileFullName.textContent
      });

      profileRoleLocationAge.textContent = `${user.location || 'N/A'} • ${user.age || 'N/A'}`;
      profileRole.textContent = user.role ? user.role.charAt(0).toUpperCase() + user.role.slice(1) : 'N/A';
      
      const emailValue = typeof user.email === 'string' && user.email.trim() ? user.email.trim() : 'No Email Provided';
      profileEmail.textContent = emailValue;
      console.log('Set email:', emailValue, 'on element:', { emailText: profileEmail.textContent });

      profilePhone.textContent = user.phone || 'N/A';
      profileGender.textContent = user.gender ? user.gender.charAt(0).toUpperCase() + user.gender.slice(1) : 'N/A';
      profileBio.textContent = user.bio || 'N/A';
      profileJoined.textContent = formatDate(user.createdAt);
      profileConnections.textContent = user.connections?.length || 0;
      profilePosts.textContent = user.posts?.length || 0;

      // Verify DOM updates for critical fields
      if (profileFullNameHeader.textContent !== fullNameValue || profileFullName.textContent !== fullNameValue) {
        console.error('Failed to update fullName in DOM:', {
          headerText: profileFullNameHeader.textContent,
          nameText: profileFullName.textContent,
          expected: fullNameValue
        });
        showAlert('Error displaying username. Please refresh the page.', 'error');
        // Retry rendering fullName
        profileFullNameHeader.textContent = fullNameValue;
        profileFullName.textContent = fullNameValue;
      }
      if (profileEmail.textContent !== emailValue) {
        console.error('Failed to update email in DOM:', {
          emailText: profileEmail.textContent,
          expected: emailValue
        });
        showAlert('Error displaying email. Please refresh the page.', 'error');
        // Retry rendering email
        profileEmail.textContent = emailValue;
      }

      // Log final DOM content
      console.log('Final DOM content:', {
        fullNameHeader: profileFullNameHeader.textContent,
        fullName: profileFullName.textContent,
        email: profileEmail.textContent,
        avatarSrc: profileAvatar.src,
        ageLocation: profileRoleLocationAge.textContent,
        role: profileRole.textContent
      });

      // Render star rating
      const stars = document.querySelectorAll('.star-rating .star');
      const averageRating = user.rating?.average || 0;
      stars.forEach((star, index) => {
        star.classList.toggle('filled', index < Math.round(averageRating));
      });

      // Render media gallery
      const images = Array.isArray(user.images) ? user.images.map(img => img && typeof img === 'string' && img.trim() ? (img.startsWith('http') ? img : `http://localhost:5000${img}`) : null).filter(img => img) : [];
      if (images.length > 0) {
        noMedia.classList.add('hidden');
        mediaGrid.innerHTML = images.map((img, idx) => `
          <img src="${img}" alt="${fullNameValue} image ${idx + 1}" class="rounded-lg object-cover h-48" onerror="this.src='${defaultProfileImage}'; console.error('Image failed to load: ${img}');">
        `).join('');
      } else {
        noMedia.classList.remove('hidden');
        mediaGrid.innerHTML = '';
      }

      // Render posts
      postsTitle.textContent = `Posts by ${fullNameValue}`;
      const posts = Array.isArray(user.posts) ? user.posts : [];
      if (posts.length > 0) {
        noPosts.classList.add('hidden');
        postsGrid.innerHTML = posts.map(post => `
          <div class="post-card p-4">
            <img src="${post.image || defaultProfileImage}" alt="Post image" class="rounded-lg object-cover h-48 w-full mb-4" onerror="this.src='${defaultProfileImage}'; console.error('Post image failed to load: ${post.image}');">
            <p class="text-sm text-gray-300">${post.content || 'No content'}</p>
          </div>
        `).join('');
      } else {
        noPosts.classList.remove('hidden');
        postsGrid.innerHTML = '';
      }

      // Re-init icons
      if (typeof feather !== 'undefined') {
        feather.replace();
      }

      console.log('renderProfile completed successfully');
    } catch (error) {
      console.error('Error in renderProfile:', error.message);
      showAlert('Error rendering profile. Please try again.', 'error');
    }
  }

  // Initialize page
  document.addEventListener('DOMContentLoaded', async () => {
    // Init icons after load
    if (typeof feather !== 'undefined') {
      feather.replace();
    }

    const urlParams = new URLSearchParams(window.location.search);
    const userId = urlParams.get('userId');
    console.log('Extracted userId from URL:', userId);
    if (!userId) {
      console.error('No userId provided in URL');
      showAlert('No user ID provided', 'error');
      window.location.href = '/home.html';
      return;
    }

    const body = document.body;
    const loader = document.getElementById('loading-overlay');
    if (!loader) {
      console.error('Loader element not found');
      showAlert('Page initialization failed. Please try again.', 'error');
      return;
    }

    body.classList.add('loading');
    loader.classList.remove('hidden');
    const user = await fetchUserProfile(userId);
    console.log('Fetched user data:', JSON.stringify(user, null, 2));
    body.classList.remove('loading');
    loader.classList.add('hidden');

    if (user) {
      renderProfile(user);
    } else {
      console.warn('No user data fetched');
      showAlert('Failed to load profile data. Please try again.', 'error');
    }

    // Handle star rating
    const stars = document.querySelectorAll('.star-rating .star');
    stars.forEach(star => {
      star.addEventListener('click', () => {
        const rating = parseInt(star.dataset.value);
        stars.forEach((s, index) => {
          s.classList.toggle('filled', index < rating);
        });
        submitRating(userId, rating);
      });
    });

    // Handle action buttons
    document.getElementById('add-connection-btn').addEventListener('click', async () => {
      const token = localStorage.getItem('token');
      if (!token) {
        showAlert('Please log in to add a connection', 'error');
        return;
      }
      try {
        const response = await fetch(`/api/users/${userId}/connect`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const data = await response.json();
        if (!response.ok) {
          throw new Error(data.error || 'Failed to add connection');
        }
        showAlert('Connection request sent!', 'success');
      } catch (error) {
        showAlert(error.message, 'error');
      }
    });

    document.getElementById('message-btn').addEventListener('click', () => {
      showAlert('Message functionality not implemented yet.', 'error');
    });
  });
</script>
</body>
</html>